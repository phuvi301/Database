
% FORMAT AND PACKAGES
% {
\documentclass[a4paper]{article}
\usepackage{a4wide,amssymb,epsfig,latexsym,multicol,array,hhline,fancyhdr}
\usepackage{tcolorbox}
\usepackage{minted}
\usepackage{vntex}
\usepackage{amsmath}
\usepackage{lastpage}
\usepackage[lined,boxed,commentsnumbered]{algorithm2e}
\usepackage{enumerate}
\usepackage{xcolor}
\usepackage{graphicx}							% Standard graphics package
\usepackage{array}
\usepackage{tabularx, caption}
\usepackage{multirow}
\usepackage{multicol}
\usepackage{rotating}
\usepackage{graphics}
\usepackage{geometry}
\usepackage{setspace}
\usepackage{epsfig}
\usepackage{tikz}
\usepackage{xfrac}
\usepackage{bm}
\usepackage{biblatex}
\usepackage[colorlinks]{hyperref}
\usepackage{booktabs}
\usepackage{tabularx}
\usepackage[utf8]{inputenc}
\setlength{\parskip}{0.2cm}
\newcommand{\cach}{\hspace*{1.5em}\ignorespaces}
% \usepackage[acronym,toc]{glossaries}
% \usepackage[symbols,nogroupskip,nonumberlist]{glossaries-extra}
\usepackage[
 sort=none,% no sorting or indexing required
 abbreviations,% create list of abbreviations
 symbols,% create list of symbols
 stylemods,style=list, % set the default glossary style
 nogroupskip, nonumberlist, nomain
]{glossaries-extra}

\usepackage{listings}
\usepackage{xcolor}

% Định nghĩa màu sắc giống VS Code/SSMS
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}
\definecolor{sqlkeyword}{rgb}{0,0,1} % Màu xanh dương cho từ khóa
% Định nghĩa màu cho terminal lỗi
\definecolor{terminalbg}{rgb}{0,0,0}
\definecolor{terminalerr}{rgb}{1,0,0}

% Style cho terminal báo lỗi
\lstdefinestyle{error-terminal}{
  backgroundcolor=\color{terminalbg},
  basicstyle=\ttfamily\color{terminalerr},
  frame=single,
  breaklines=true,
  columns=fullflexible,
  keepspaces=true
  % chỉnh cỡ chữ thành 10
  \footnotesize
}
\lstdefinelanguage{JavaScript}{
  keywords={typeof, new, true, false, catch, function, return, null, catch, switch, var, if, in, while, do, else, case, break, try, const, let},
  keywordstyle=\color{blue}\bfseries,
  ndkeywords={class, export, boolean, throw, implements, import, this},
  ndkeywordstyle=\color{darkgray}\bfseries,
  identifierstyle=\color{black},
  sensitive=false,
  comment=[l]{//},
  morecomment=[s]{/*}{*/},
  commentstyle=\color{purple}\ttfamily,
  stringstyle=\color{red}\ttfamily,
  morestring=[b]',
  morestring=[b]"
}
% Cấu hình style cho SQL
\lstdefinestyle{sqlstyle}{
    language=SQL,
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{sqlkeyword}\bfseries, % Từ khóa in đậm màu xanh
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize, % Font chữ code
    breakatwhitespace=false,         
    breaklines=true,                 % Tự động xuống dòng nếu quá dài
    captionpos=b,                    % Vị trí chú thích (bottom)
    keepspaces=true,                 
    numbers=left,                    % Hiển thị số dòng bên trái
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2,
    frame=single,                    % Thêm khung viền quanh code
    morekeywords={use, go, references, if, exists} % Thêm các từ khóa của MS SQL (nếu cần)
}

\lstset{style=sqlstyle}
% FORMATTING
% {
\DeclareMathOperator{\arccot}{arccot}
\captionsetup[table]{name=Bảng}
\captionsetup[figure]{name=Hình}
\newenvironment{Description}{\list{}{%
    \let\makelabel\descriptionlabel    % this comes from the original description environment
    \setlength{\rightmargin}{\leftmargin}% this comes from the original quote environment
    \setlength{\labelwidth}{0pt}%          this is new
    }}{\endlist}

\addbibresource{citations.bib}
    
\hypersetup{urlcolor=blue,linkcolor=black,citecolor=black,colorlinks=true} 
\usetikzlibrary{arrows,snakes,backgrounds}
\definecolor{mathblue}{RGB}{0,114,188}
% \makeatletter  \def\m@th{\mathsurround\z@\color{mathblue}} \makeatother
% \everymath{\color{mathblue}}
% \setmathfont[Color=000000]{Arial}
%\usepackage{pstcol} 								% PSTricks with the standard color package
\newtheorem{theorem}{{\bf Theorem}}
\newtheorem{property}{{\bf Property}}
\newtheorem{proposition}{{\bf Proposition}}
\newtheorem{corollary}[proposition]{{\bf Corollary}}
\newtheorem{lemma}[proposition]{{\bf Lemma}}

\AtBeginDocument{\renewcommand{\listfigurename}{Danh sách hình ảnh}}
\AtBeginDocument{\renewcommand{\listtablename}{Danh sách bảng biểu}}
\AtBeginDocument{\renewcommand*\contentsname{Mục lục}}
\AtBeginDocument{\renewcommand*\refname{Tài liệu tham khảo}}
%\usepackage{fancyhdr}

\setlength{\headheight}{40pt}
\pagestyle{fancy}
\fancyhead{} % clear all header fields
\fancyhead[L]{
 \begin{tabular}{rl}
    \begin{picture}(25,15)(0,0)
    \put(0,-8){\includegraphics[width=8mm, height=8mm]{Images/hcmut.png}}
    %\put(0,-8){\epsfig{width=10mm,figure=hcmut.eps}}
   \end{picture}&
	%\includegraphics[width=8mm, height=8mm]{hcmut.png} & %
	\begin{tabular}{l}
		\textbf{\bf \ttfamily Trường Đại học Bách Khoa TP.Hồ Chí Minh}\\
		\textbf{\bf \ttfamily Khoa Khoa học và Kỹ thuật máy tính}
	\end{tabular} 	
 \end{tabular}
}
\fancyhead[R]{
	\begin{tabular}{l}
		\tiny \bf \\
		\tiny \bf 
	\end{tabular}  }
\fancyfoot{} % clear all footer fields
\fancyfoot[L]{\scriptsize \ttfamily Báo cáo Bài tập lớn Hệ cơ sở dữ liệu (TN) (CO2014) - HK251 - Năm học 2025 - 2026}
\fancyfoot[R]{\scriptsize \ttfamily Trang {\thepage}/\pageref{LastPage}}
\renewcommand{\headrulewidth}{0.3pt}
\renewcommand{\footrulewidth}{0.3pt}

\setcounter{secnumdepth}{4}
\setcounter{tocdepth}{4}

\makeatletter
\newcounter {subsubsubsection}[subsubsection]
\renewcommand\thesubsubsubsection{\thesubsubsection .\@alph\c@subsubsubsection}
\newcommand\subsubsubsection{\@startsection{subsubsubsection}{4}{\z@}%
                                     {-3.25ex\@plus -1ex \@minus -.2ex}%
                                     {1.5ex \@plus .2ex}%
                                     {\normalfont\normalsize\bfseries}}
\newcommand*\l@subsubsubsection{\@dottedtocline{3}{10.0em}{4.1em}}
\newcommand*{\subsubsubsectionmark}[1]{}
% \def\m@th{\mathsurround\z@\color{mathblue}}
\makeatother
% }
% }

% ACRONYMS & SYMBOLS
% {
% \makeglossaries

% }
%
% DOCUMENT
\begin{document}

% TITLE PAGE
\begin{titlepage}
	\begin{center}
		ĐẠI HỌC QUỐC GIA THÀNH PHỐ HỒ CHÍ MINH\\
		TRƯỜNG ĐẠI HỌC BÁCH KHOA\\
		KHOA KHOA HỌC VÀ KỸ THUẬT MÁY TÍNH\\
	\end{center}

	\vspace{1cm}

	\begin{figure}[h!]
		\begin{center}
			\includegraphics[width=3cm]{Images/hcmut.png}
		\end{center}
	\end{figure}

	\vspace{1cm}


	\begin{center}
		\begin{tabular}{c}
			\multicolumn{1}{c}{\textbf{{\Large Hệ cơ sở dữ liệu (TN) (CO2014)}}} \\
			~~                                                                   \\
			\hline
			\\
			\multicolumn{1}{c}{\textbf{{\Large Báo cáo bài tập lớn  }}}          \\
			\\
			\textbf{\textit{{\Huge Hệ thống đặt vé xem phim }}}                  \\
			\\
			\hline
		\end{tabular}
	\end{center}

	\begin{table}[h]
		\centering
		\begin{tabular}{rl}
			\hspace{3 cm}\textbf{GVHD}:
			                    & Dương Huỳnh Anh Đức                                    \\[8pt]

			\textbf{Lớp}:       & L05                                                    \\ [8pt]
			\textbf{Sinh viên}: & Lư Chấn Vũ - 2313955 \emph{(Nhóm 7)}                   \\
			                    & Nguyễn Phú Vinh - 2313922 \emph{(Nhóm 7)}              \\
			                    & Huỳnh Xuân Quốc Việt - 2313891 \emph{(Nhóm 7)}         \\
			                    & Lê Minh Khoa - 2311593 \emph{(Nhóm 7)}                 \\
			                    & Lê Minh Trí - 2313593 \emph{(Nhóm 7, \textbf{Leader})} \\
		\end{tabular}
	\end{table}
	\vfill
	\begin{center}
		{\footnotesize TP. HỒ CHÍ MINH, 09/2025}
	\end{center}
\end{titlepage}

\pagebreak
\tableofcontents

\pagebreak

% Glossaries
% {}
% \printunsrtglossary[type={symbols}, title={Danh sách kí hiệu}]
% \printunsrtglossary[type={abbreviations}, title={Danh sách từ viết tắt}]
\pagebreak
\listoffigures
\listoftables
\pagebreak
\addcontentsline{toc}{section}{\listfigurename}
\addcontentsline{toc}{section}{\listtablename}

% 

% Member list
\section*{Danh sách thành viên và nhiệm vụ}
\addcontentsline{toc}{section}{Danh sách thành viên và nhiệm vụ}
\begin{center}
	\begin{table}[H]
		\centering
		\begin{tabular}{|c|c|c|l|c|}
			\hline
			\textbf{STT}       & \textbf{Họ và tên}                    & \textbf{MSSV}            & \textbf{Nhiệm vụ} & \textbf{\% hoàn thành} \\
			\hline
			%%%%%Student 1%%%%%%%%%%
			\multirow{3}{*}{1} & \multirow{3}{*}{Lư Chấn Vũ}           & \multirow{3}{*}{2313955} &
			- Phần 1.3         & \multirow{3}{*}{100\%}                                                                                        \\
			                   &                                       &                          & -  Phần 2, 3      &                        \\
			\hline
			%%%%%Student 2%%%%%%%%%%
			\multirow{3}{*}{2} & \multirow{3}{*}{Nguyễn Phú Vinh}      & \multirow{3}{*}{2313922} &
			- Phần 1.2.2       & \multirow{3}{*}{100\%}                                                                                        \\
			                   &                                       &                          & -  Phần 2, 3      &                        \\
			\hline
			%%%%%Student 3%%%%%%%%%%
			\multirow{3}{*}{3} & \multirow{3}{*}{Huỳnh Xuân Quốc Việt} & \multirow{3}{*}{2313891} &
			- Phần 1.2.1       & \multirow{3}{*}{100\%}                                                                                        \\
			                   &                                       &                          & -  Phần 2, 3      &                        \\
			\hline
			%%%%%Student 4%%%%%%%%%%
			\multirow{3}{*}{4} & \multirow{3}{*}{Lê Minh Khoa}         & \multirow{3}{*}{2311593} &
			- Phần 1.2.2       & \multirow{3}{*}{100\%}                                                                                        \\
			                   &                                       &                          & -  Phần 2, 3      &                        \\
			\hline
			%%%%%Student 5%%%%%%%%%%
			\multirow{3}{*}{5} & \multirow{3}{*}{Lê Minh Trí}          & \multirow{3}{*}{2313593} &
			-  Phần 1.1        & \multirow{3}{*}{100\%}                                                                                        \\
			                   &                                       &                          & -  Phần 2, 3      &                        \\
			\hline
		\end{tabular}
		\caption{\label{table1}Danh sách thành viên và nhiệm vụ}
	\end{table}
\end{center}
\pagebreak
\section*{\begin{center}
	  \textbf{Lời mở đầu}
  \end{center}}

\cach Trong kỷ nguyên số hiện nay, dữ liệu được xem như là tài sản quý giá của mọi tổ chức và doanh nghiệp. Việc thu thập, quản lý và khai thác dữ liệu một cách hiệu quả đóng vai trò quan trọng trong quá trình vận hành, phát triển dịch vụ cũng như ra quyết định chiến lược. Cơ sở dữ liệu (CSDL) chính là nền tảng cốt lõi giúp đảm bảo cho các hệ thống thông tin hoạt động ổn định, chính xác và an toàn. Một cơ sở dữ liệu được thiết kế khoa học không chỉ hỗ trợ lưu trữ và xử lý khối lượng dữ liệu lớn mà còn giúp tối ưu hiệu suất, duy trì tính toàn vẹn và tạo điều kiện mở rộng hệ thống trong tương lai.

Trong thực tế, nhiều lĩnh vực ứng dụng công nghệ thông tin đều cần đến các hệ thống cơ sở dữ liệu, điển hình như thương mại điện tử, ngân hàng, giáo dục, và đặc biệt là lĩnh vực giải trí. Một trong những dịch vụ giải trí phổ biến hiện nay là rạp chiếu phim, nơi nhu cầu đặt vé trực tuyến ngày càng gia tăng. Các ứng dụng đặt vé xem phim không chỉ giúp khách hàng dễ dàng lựa chọn phim, suất chiếu, vị trí ghế ngồi và thanh toán trực tuyến, mà còn hỗ trợ nhà quản lý rạp kiểm soát lịch chiếu, doanh thu, khuyến mãi cũng như tình trạng đặt vé theo thời gian thực. Tất cả những chức năng này đều được xây dựng và vận hành dựa trên một hệ thống cơ sở dữ liệu được thiết kế bài bản.

Trong khuôn khổ môn \textit{Hệ cơ sở dữ liệu} tại Trường Đại học Bách Khoa -- ĐHQG TP.HCM, nhóm chúng em thực hiện đề tài \textbf{``Xây dựng cơ sở dữ liệu cho hệ thống đặt vé xem phim''}. Mục tiêu của đề tài là phân tích yêu cầu nghiệp vụ của hệ thống, xây dựng sơ đồ EERD (Enhanced Entity-Relationship Diagram) để mô hình hóa các thực thể và mối quan hệ, sau đó tiến hành ánh xạ sang mô hình quan hệ để triển khai dưới dạng các bảng trong hệ quản trị cơ sở dữ liệu. Quá trình này không chỉ giúp nhóm củng cố và vận dụng các kiến thức lý thuyết đã học, mà còn rèn luyện kỹ năng phân tích, mô hình hóa và triển khai một cơ sở dữ liệu trong tình huống thực tế.

Thông qua báo cáo này, nhóm mong muốn trình bày một cách có hệ thống các bước thiết kế cơ sở dữ liệu cho một ứng dụng đặt vé xem phim, từ khâu phân tích đến triển khai. Đây sẽ là nền tảng quan trọng giúp sinh viên tiếp cận gần hơn với thực tiễn, đồng thời làm quen với các yêu cầu về chất lượng, tính chính xác và khả năng mở rộng của một hệ thống cơ sở dữ liệu trong bối cảnh công nghệ ngày nay.


\pagebreak
\section{Phân tích và mô tả yêu cầu dữ liệu}
\subsection{Tìm hiểu ứng dụng/hệ thống}
\subsubsection{Tên ứng dụng/hệ thống}
\cach Để khảo sát và tham khảo cho việc xây dựng cơ sở dữ liệu ứng dụng đặt vé xem phim, nhóm lựa chọn hệ thống CGV Cinemas Việt Nam làm đối tượng nghiên cứu chính. CGV hiện là một trong những chuỗi rạp chiếu phim lớn tại Việt Nam, cung cấp ứng dụng di động (CGV Cinemas trên App Store và Google Play) cũng như website chính thức tại địa chỉ: $\href{https://www.cgv.vn/.}{CGV}$.


\indent Ứng dụng cho phép người dùng dễ dàng tra cứu thông tin phim đang chiếu, xem trailer, lịch chiếu, chọn rạp, chọn suất chiếu và ghế ngồi trực tiếp trên giao diện. Sau khi đặt vé, khách hàng có thể thanh toán qua nhiều phương thức khác nhau (thẻ ngân hàng, ví điện tử, thẻ thành viên) và nhận vé điện tử dưới dạng mã QR để quét khi vào rạp. Ngoài ra, ứng dụng còn tích hợp hệ thống hội viên với tính năng tích điểm, đổi quà và sử dụng các ưu đãi, khuyến mãi đi kèm. Những chức năng này phản ánh luồng nghiệp vụ cốt lõi của một ứng dụng đặt vé hiện đại, bao gồm: quản lý phim, lịch chiếu, rạp chiếu, ghế ngồi, đơn đặt vé, thanh toán và ưu đãi khách hàng. Việc nghiên cứu CGV giúp định hình rõ các yêu cầu nghiệp vụ cần thiết cho hệ thống đặt vé, từ đó xây dựng mô hình dữ liệu phù hợp.
\subsubsection{Phân tích nghiệp vụ}
\cach Dựa trên khảo sát hệ thống CGV Cinemas, các chức năng chính của ứng dụng đặt vé xem phim có thể phân thành các nhóm: chức năng cho khách hàng, chức năng cho nhân viên, chức năng cho quản trị rạp và các luồng nghiệp vụ cốt lõi.
\\
\\
\cach \textbf{Chức năng chính:}


\indent Đối với khách hàng, hệ thống cung cấp các tính năng như đăng ký/đăng nhập tài khoản, tìm kiếm phim, xem lịch chiếu, đặt vé trực tuyến, thanh toán, quản lý vé và theo dõi khuyến mãi. Với nhân viên, hệ thống hỗ trợ tra cứu thông tin suất chiếu, xác nhận và in vé, quản lý đặt chỗ tại quầy, cũng như hỗ trợ khách hàng trong quá trình sử dụng dịch vụ. Nhóm chức năng dành cho quản trị rạp bao gồm quản lý phim, suất chiếu, phòng chiếu, ghế ngồi, giá vé, chương trình khuyến mãi, cùng với việc thống kê doanh thu và theo dõi tình trạng hoạt động của rạp. Các nhóm chức năng này kết hợp với nhau tạo nên một hệ thống đồng bộ, đáp ứng đầy đủ nhu cầu từ người dùng cuối đến công tác vận hành và quản lý rạp chiếu phim.
\\
\\
\cach \textbf{Luồng nghiệp vụ cốt lõi:}
\begin{enumerate}
	\item Khách hàng mở ứng dụng $\rightarrow$ xem danh sách phim $\rightarrow$ chọn phim.
	\item Chọn rạp $\rightarrow$ chọn ngày giờ $\rightarrow$ chọn ghế $\rightarrow$ chọn combo (nếu có).
	\item Thực hiện thanh toán $\rightarrow$ nhận vé điện tử (QR code).
	\item Đến rạp $\rightarrow$ quét QR code tại cổng $\rightarrow$ vào phòng chiếu.
	\item Sau khi xem phim $\rightarrow$ hệ thống lưu lịch sử, cộng điểm hội viên.
\end{enumerate}

\subsection{Mô tả hệ thống đề xuất}
\subsubsection{Mô tả người dùng và chức năng chính của hệ thống}
\cach Ứng dụng đặt vé xem phim được thiết kế để phục vụ nhu cầu mua vé nhanh, chọn ghế trực quan và quản lý vận hành rạp hiệu quả. Hệ thống gồm các vai trò chính, mỗi vai trò có tập chức năng riêng phục vụ cả trải nghiệm khách hàng và nghiệp vụ rạp.
\\
\\
\cach \textbf{Người dùng của hệ thống}
\begin{itemize}
	\item \textbf{Khách hàng (User, End-user)}: là người dùng cuối truy cập app/web để tra cứu phim, đặt vé và sử dụng dịch vụ tại rạp. Khách hàng có thể là người dùng chưa đăng ký (khách vãng lai) hoặc thành viên (có tài khoản, tích điểm, nhận ưu đãi). Nhu cầu chính: thông tin phim rõ ràng, tìm rạp nhanh, chọn ghế trực quan, thanh toán an toàn, nhận vé điện tử, theo dõi lịch sử và ưu đãi cá nhân.
	\item \textbf{Nhân viên rạp (Staff / Box Office / Gate Concession)}: là nhân viên trực tiếp vận hành tại rạp: bán vé tại quầy, xác thực vé QR ở cổng, xử lý đổi/hủy, quản lý tình trạng ghế và hỗ trợ khách. Họ cần giao diện đơn giản để check-in, huỷ/đổi vé, khóa ghế tạm thời, và truy xuất thông tin đơn hàng nhanh.
	\item \textbf{Quản trị hệ thống (Admin / Manager)}:là người quản lý cấp cao của rạp hoặc chuỗi rạp, chịu trách nhiệm cấu hình hệ thống: thêm phim, lập lịch chiếu, điều chỉnh giá, tạo khuyến mãi, xem báo cáo doanh thu, quản lý tài khoản nhân viên và phân quyền. Họ cần công cụ báo cáo, audit log và cấu hình tích hợp (cổng thanh toán, POS).
\end{itemize}
\cach \textbf{Chức năng chính của hệ thống}
\begin{itemize}
	\item \textbf{Chức năng dành cho khách hàng:} Khách hàng có thể: đăng ký/đăng nhập và quản lý hồ sơ cá nhân; xem danh sách phim, xem chi tiết phim (tóm tắt, thời lượng, thể loại, độ tuổi), và xem trailer; tìm kiếm và lọc phim theo rạp/ngày/thể loại; chọn rạp và suất chiếu; chọn ghế trực quan trên sơ đồ phòng (hiển thị ghế trống/đã bán/không sử dụng); thêm combo đồ ăn/đồ uống vào đơn; áp dụng mã khuyến mãi hoặc sử dụng điểm thành viên khi đặt vé; thanh toán trực tuyến qua thẻ/QR/ví điện tử hoặc thanh toán tại quầy; nhận vé điện tử kèm mã QR và email/xác nhận; xem lịch sử đặt vé, in lại/e-ticket và yêu cầu đổi/hủy theo chính sách; nhận thông báo đẩy về khuyến mãi, thay đổi suất chiếu hoặc nhắc lịch; và đánh giá phim/để lại phản hồi. Mỗi chức năng phải rõ trạng thái (thành công/thất bại) và có thông báo lỗi dễ hiểu.
	\item \textbf{Chức năng dành cho nhân viên rạp:} Nhân viên có thể: check-in khách bằng quét mã QR hoặc nhập mã thủ công; xác thực và huỷ mã QR; thực hiện bán vé trực tiếp tại quầy (tạo đơn, chọn ghế, in vé giấy); quản lý sơ đồ ghế trong ca (khóa/giải phóng ghế, đánh dấu ghế hỏng); xử lý yêu cầu đổi/hủy theo quy định (hoàn tiền, đổi suất); quản lý đơn hàng combo/kho hàng quầy; xem danh sách suất chiếu trong ca và số ghế còn trống; hỗ trợ in lại vé hoặc gửi lại vé điện tử cho khách; và báo cáo vấn đề kỹ thuật hoặc yêu cầu hỗ trợ lên admin. Giao diện dành cho nhân viên cần thao tác nhanh, ít bước, và có kiểm tra phân quyền.
	\item \textbf{Chức năng dành cho quản trị hệ thống:} Admin thực hiện: quản lý phim (thêm, sửa, ngưng chiếu, upload poster/trailer), quản lý rạp và phòng chiếu (thêm rạp, cấu hình phòng, sơ đồ ghế, loại phòng), lập lịch chiếu và điều chỉnh suất (cập nhật giá, format, thời lượng); thiết lập chính sách giá (giá theo loại ghế, khung giờ, ưu đãi), tạo/quản lý chương trình khuyến mãi và mã giảm giá; quản lý người dùng và phân quyền (tạo tài khoản nhân viên, cấp/thu quyền); giám sát đơn hàng và quản lý tài chính (đối chiếu giao dịch, hoàn tiền, quản lý phiếu thu); báo cáo và phân tích (doanh thu theo rạp/phim/suất, tỉ lệ lấp ghế, báo cáo theo khoảng thời gian); cấu hình tích hợp (cổng thanh toán, hệ thống POS, email/SMS gateway); theo dõi nhật ký hoạt động (audit log), backup dữ liệu và cài đặt bảo mật; và quản lý hệ thống (cấu hình bản thử nghiệm, release, monitor). Tất cả hành động quản trị cần có cơ chế kiểm tra truy vết và phân tầng quyền để tránh thao tác trái phép.
\end{itemize}

\subsubsection{Mô tả các kiểu thực thể, các thuộc tính, mối liên kết}
\cach Hệ thống cơ sở dữ liệu đặt vé xem phim quản lý và lưu trữ các thông tin về Người dùng (User), Phim (Movie), Rạp chiếu (Cinema), Phòng chiếu (Room), Suất chiếu (Showtime), Ghế (Seat), Đặt vé (Booking), Thanh toán (Payment), Khuyến mãi (Voucher), Nhân viên (Employee) và các dịch vụ về đồ ăn và thức uống.

Hệ thống đặt vé xem phim cho phép quản lý nhiều rạp cùng lúc.
Mỗi rạp được gán mã định danh riêng (CinemaID) lưu kèm theo tên (Name) và địa chỉ (Address).
Mỗi rạp được cấp một số hotline riêng (Hotline) cho phép khách hàng gọi đặt vé online.

Mỗi rạp quản lý một số lượng phòng chiếu nhất định.
Mỗi phòng chiếu được quản lý bằng mã phòng (RoomID) riêng biệt giữa các rạp.
Mỗi phòng được đánh tên riêng (RoomName) và được chia thành nhiều loại phòng (RoomType) với các sức chứa khác nhau (Capacity).

Sức chứa của các phòng là khác nhau nên từng ghế trong mỗi phòng chiếu được quản lý bằng mã riêng biệt (SeatInfo) đảm bảo phân biệt các ghế trong cùng phòng.
Mỗi ghế gắn kèm thông tin về hạng ghế (SeatType) cho khách hàng có nhiều sự lựa chọn đa dạng.

Hệ thống cơ sở dữ liệu quản lý và lưu trữ thông tin của khách hàng/người dùng đặt vé.
Mỗi người dùng được cấp một mã số định danh riêng (UserID) và yêu cầu thông tin về họ và tên (gồm phần tên (FirstName) và phần họ (LastName)), địa chỉ email duy nhất (Email), mật khẩu tài khoản (Password), số điện thoại (Phone) của người dùng.
Ngoài ra, hệ thống cũng lưu trữ thông tin về ngày sinh (Birthday), giới tính (Gender) cũng như ngày tạo tài khoản (CreatedAt) để đáp ứng các dịch vụ mở rộng của hệ thống.

% Người dùng đã có thông tin có thể đặt vé xem phim trực tuyến kết hợp sử dụng các mã khuyến mãi tích lũy được từ hệ thống.
% Mỗi vé được mua được quản lý bằng mã số riêng (BookingID) đồng thời bao gồm thông tin về suất chiếu phim đã đặt (ShowtimeID) và thời gian đã đặt (BookingTime). 
% Đồng thời vé cũng bao gồm giá tiền (TotalPrice) và trạng thái thanh toán hiện tại (Status). Tất nhiên, mỗi người dùng có thể đặt bao nhiêu vé tùy ý.

Người dùng đã có thông tin có thể đặt vé xem phim trực tuyến kết hợp sử dụng các mã khuyến mãi tích lũy được từ hệ thống.
Mỗi vé được quản lý bằng mã số riêng (BookingID) và ghi nhận thời gian đặt (BookingTime). Một đơn vé bao gồm thông tin về suất chiếu phim đã đặt (ShowtimeID), thông tin về vị trí ghế đã chọn (SeatID).
Tổng giá tiền (TotalPrice) của đơn vé sẽ được tính toán dựa trên các thông tin của vé sau khi đã áp dụng các mã khuyến mãi từ người dùng.
Tất nhiên, mỗi người dùng có thể đặt bao nhiêu vé tùy ý.

Mỗi suất chiếu được quản lý bằng mã định danh riêng không trùng lặp (ShowtimeID).
Suất chiếu chứa thông tin về thời gian chiếu (StartTime và EndTime) cũng như giá cơ bản cho một suất (BasePrice).
Mỗi bộ phim có thể có nhiều suất chiếu khác nhau trong ngày và mỗi suất chiếu được quy định một phòng chiếu cụ thể.

Thông tin về các phim được chiếu được hệ thống lưu trữ chi tiết.
Cụ thể, mỗi phim được đánh một mã số riêng để quản lý (MovieID), cũng như bao gồm tên phim (Title), thể loại (Genre), thời lượng chiếu (Duration), ngôn ngữ hỗ trợ (Language), độ tuổi giới hạn (AgeRating), mô tả cơ bản về nội dung phim (Description).
Ngoài ra, mỗi phim còn lưu thêm thông tin về các diễn viên trong phim (Actors), đạo diễn bộ phim (Director), ngày khởi chiếu (ReleaseDate) kèm theo poster (Poster) và trailer khởi chiếu (Trailer).
Mỗi bộ phim có thể là phần trước hoặc phần sau của một series phim nào đó.

Hệ thống cũng triển khai các chương trình khuyến mãi nhằm thu hút khách hàng.
Mỗi chiến dịch khuyến mãi tung ra hàng ngàn voucher khuyến mãi khác nhau.
Các voucher được quản lý bằng mã voucher nhận thưởng (Promo Code).
Mỗi voucher có kiểu khuyến mãi riêng (DiscountType) như giảm theo phần trăm hay giảm theo số tiền cùng với giá trị được giảm của vé (DiscountValue), đồng thời cũng yêu cầu các điều kiện áp dụng khác nhau cho từng mã (Condition).
Mỗi đơn vé được đặt có thể áp dụng nhiều mã khuyến mãi khác nhau (nếu có) để giảm giá vé, đồng thời mỗi mã có thể được sử dụng nhiều lần bởi cho nhiều vé khác nhau.
Mỗi mã cũng cần có thời gian bắt đầu (StartDate) và kết thúc (EndDate) để đảm bảo mã không bị lạm dụng.

Hệ thống cung cấp các dịch vụ đồ ăn thức uống đi kèm nhằm nâng cao trải nghiệm khách hàng.
Mỗi món ăn thức uống được quản lý bằng mã riêng (FB ID) và bao gồm tên món (FBName), giá tiền (Price) và số lượng mua (Quantity) cho từng món.
Mỗi món ăn thức uống có thể được đặt kèm trong mỗi đơn vé (nếu có) và mỗi đơn vé có thể đặt nhiều món khác nhau bao gồm chỉ số quản lý số lượng món đã đặt (Num of Items).

Hệ thống đặt vé xem phim được vận hành bởi đội ngũ nhân viên chuyên nghiệp.
Trong đó, mọi nhân viên được cấp một mã số nhân viên riêng (EmployeeID), được phân bổ vị trí làm việc tại từng rạp riêng biệt (CinemaID).
Hệ thống có thể kiểm soát được số lượng nhân viên (Num of Employee) đang làm việc tại mỗi rạp.
Hệ thống cũng cần lưu thông tin về tên nhân viên (Name), ca làm việc (Shift) và lương thưởng (Salary) của từng nhân viên.
Nhân viên được chia thành hai loại chính là quản lý (Manager) và nhân viên (Staff).
Với nhân viên, hệ thống lưu trữ về vị trí làm việc (Position) để phân biệt các vai trò khác nhau trong rạp.
Với quản lý, hệ thống lưu trữ số lượng các nhân viên (Num of staff) mà họ quản lý trực tiếp.

Các bộ phim được chiếu tại rạp được kiểm soát bởi quản lý rạp. Mỗi bộ phim được quản lý trực tiếp bởi quản lý hoặc được hệ thống xử lý không can thiệp. Do sức mạnh hệ thống xử lý tự động còn hạn chế, quản lý đôi khi phải đảm nhận nhiều bộ phim.
Trong quá trình quản lý bộ phim, hệ thống cần lưu thông tin cho biết hành động của quản lý rạp với bộ phim (ActionType) đó bao gồm thêm, sửa, dừng chiếu hay các cập nhật khác, đồng thời ghi nhận thời gian thực hiện hành động (ActionDate).
Tương tự với bộ phim, mỗi suất chiếu trong rạp cũng phải được quản lý bởi một nhân viên quản lý trong khi mỗi quản lý có thể quản lý nhiều suất chiếu khác nhau.
Suất chiếu được tạo ra và kiểm duyệt dựa trên các thông tin mà quản lý rạp cung cấp bao gồm lịch dự kiến (Schedule Date), thời lượng dự kiến (Duration Adjust), hình thức suất chiếu (Format) và giá vé điều chỉnh (PriceAdjust).
Quản lý rạp cũng chịu trách nhiệm quản lý các phòng chiếu trong rạp. Mỗi phòng chiếu được quản lý bởi một quản lý và mỗi quản lý có thể quản lý nhiều phòng chiếu khác nhau.
Hệ thống cần lưu thông tin trong quá trình quản lý các phòng chiếu cho biết hành động của quản lý với phòng chiếu (ActionType) đó bao gồm quản lý cấu trúc phòng, loại phòng và sơ đồ bố trí ghế, đồng thời ghi nhận thời gian thực hiện hành động (ActionDate).

% STAFF — Sell → BOOKING
Bên cạnh việc đặt vé trực tuyến, khách hàng cũng có thể đến trực tiếp quầy bán vé của rạp để mua vé. Mỗi quầy bán vé được định danh một mã số riêng (CounterID) cho phép một nhân viên bán vé vận hành quầy.
Trong quá trình bán vé, hệ thống cần lưu thông tin về thời gian bán vé (SellTime) và trạng thái xuất vé (PrintStatus) để đảm bảo vé không bị làm giả.
Đối với khách hàng làm mất vé, nhân viên có thể hỗ trợ in lại vé nếu khách hàng cung cấp đầy đủ thông tin về mã vé (BookingID) và thông tin cá nhân đã đăng ký.
% STAFF — Manage → SEAT
Ngoài việc bán vé, nhân viên còn chịu trách nhiệm quản lý sơ đồ ghế. Một nhân viên được phân công quản lý một dãy các ghế và đồng thời mỗi dãy ghế cũng được kiểm tra bởi nhiều nhân viên khác nhau.
Hệ thống cho phép nhân viên cập nhật tình trạng của ghế (SeatlockStatus) bao gồm khóa ghế, mở khóa ghế hay đánh dấu ghế hỏng, đồng thời ghi nhận thời gian thực hiện cập nhật (UpdateTime).
% STAFF — Handle → PAYMENT
Bên cạnh đó, nhân viên còn chịu trách nhiệm xử lý các yêu cầu đổi/hủy giao dịch tại quầy. Mỗi yêu cầu giao dịch được xử lý bởi một nhân viên và mỗi nhân viên có thể xử lý nhiều yêu cầu khác nhau.
Hệ thống cần lưu thông tin về loại yêu cầu (RequestType) gồm đổi, hủy các giao dịch đã thực hiện kèm với số tiền hoàn trả (RefundAmount) và thời điểm các yêu cầu được xử lý (ProcessDate).

Hệ thống cho phép người dùng thanh toán bằng nhiều hình thức khác nhau và lưu trữ thông tin thanh toán.
Mỗi thanh toán/hóa đơn có mã hóa đơn riêng (PaymentID) và thuộc về một vé duy nhất (BookingID).
Mỗi thanh toán có thể là giao dịch qua thẻ tín dụng, ví điện tử hay trực tiếp bằng tiền mặt.
Đối với các thanh toán trực tuyến, hệ thống lưu trữ thông tin về mã giao dịch (PaymentCode) do bên thứ ba cung cấp và thông tin về số tài khoản (Card Number) và ngân hàng xử lý giao dịch (Bank Name).
Đối với các thanh toán trực tiếp tại quầy, hệ thống lưu trữ thông tin về tên nhân viên thu ngân (StaffName).
Trạng thái thanh toán (Status) cũng cần được lưu cho phép hệ thống kiểm tra giao dịch hoàn tất hay chưa.
Khi giao dịch hoàn tất, hệ thống cũng cần ghi nhận thời gian thực hiện giao dịch (PaymentTime), đảm bảo tính minh bạch cho hệ thống, nâng cao sự tín nhiệm với khách hàng.

\subsection{Mô tả các ràng buộc ngữ nghĩa}
\begin{itemize}
	\item Sức chứa (Capacity) của mỗi phòng chiếu (Room) phải có giá trị dương.
	\item Thời lượng chiếu (Duration) của mỗi bộ phim (Movie) phải có giá trị dương.
	\item Thời gian bắt đầu chiếu (StartTime) của mỗi suất chiếu (Showtime) phải sớm hơn thời gian kết thúc của nó (EndTime).
	\item Ngày công chiếu (ReleaseDate) của mỗi bộ phim (Movie) phải sớm hơn ngày khởi chiếu (Showtime.StartTime).
	\item Giá cơ bản của mỗi suất (BasePrice) phải có giá trị dương.
	\item Hai suất chiếu (Showtime) cùng một phòng chiếu (Room) không được trùng lắp nhau.
	\item Mật khẩu đăng nhập (Password) của người dùng (User) phải là chuỗi có ít nhất 8 kí tự, trong đó phải có ít nhất 1 kí tự chữ hoa, ít nhất 1 kí tự số, ít nhất 1 kí tự đặc biệt thuộc tập {$@$, $\mathdollar$, $\#$, $\%$, !, $\&$}.
	\item Ngày sinh (Birthday) của người dùng (User) phải sớm hơn ngày hiện tại.
	\item Số điện thoại (Phone) của người dùng (User) phải là chuỗi có 10 chữ số.
	\item Thời gian đặt vé (BookingTime) phải sớm hơn thời gian bắt đầu của suất chiếu (Showtime.StartTime).
	\item Số lượng nhân viên (Num of Employee) đang làm việc tại mỗi rạp được tính bằng tổng số nhân viên có EmployeeID tương ứng trong bảng Employee.
	\item Giới tính (Gender) của người dùng (User) phải thuộc tập {"Male", "Female"}.
	\item Giá tiền (Price) của mỗi món ăn thức uống phải có giá trị dương.
	\item Số lượng món đã đặt (Num of Items) được tính bằng tổng số lượng món (Quantity) ứng với các sản phẩm được đặt trong bảng F\&B.
	\item Hạng ghế (SeatType) phải thuộc tập {"Standard", "VIP", "Couple", "Deluxe"}.
	\item Thời gian bắt đầu (Discount.StartDate) của mỗi voucher khuyến mãi phải sớm hơn (Discount.EndDate).
	\item Ca làm việc (Shift) của nhân viên (Employee) thuộc tập {"Morning", "Afternoon", "Evening"}.
	\item Lương thưởng (Salary) của nhân viên (Employee) phải có giá trị dương.
	\item TotalPrice = tổng các Showtime.BasePrice + tổng các F\&B.Price - Voucher.DiscountValue.
	\item Thời gian thực hiện giao dịch (PaymentTime) phải trễ hơn thời gian đặt (BookingTime).
\end{itemize}
\pagebreak
\section{Thiết kế EERD}
\begin{figure}[H]
	\includegraphics[width=1.2\textwidth]{Images/EERD.png}
	\caption{Sơ đồ EERD cho hệ thống đặt vé xem phim}
\end{figure}
\pagebreak
\section{Ánh xạ lược đồ EERD sang lược đồ CSDL}
\begin{figure}[H]
	\includegraphics[width=1.2\textwidth]{Images/mapping.png}
	\caption{Ánh xạ lược đồ EERD sang lược đồ CSDL}
\end{figure}
\pagebreak
\section{Đường dẫn truy cập các sơ đồ}
\cach Đường dẫn truy cập các sơ đồ như sau: $\href{https://drive.google.com/drive/folders/1Zwp_fdw1I9jSBugBzoHM8gc0wFd-WgGM?usp=sharing}{Link}$
\section{Tạo bảng và dữ liệu mẫu}

\cach Dựa trên thiết kế EERD và lược đồ quan hệ đã phân tích ở Bài tập lớn 1, nhóm tiến hành hiện thực hóa cơ sở dữ liệu trên hệ quản trị SQL Server. Phần này trình bày các câu lệnh DDL (Data Definition Language) để tạo bảng, thiết lập các ràng buộc toàn vẹn và DML (Data Manipulation Language) để thêm dữ liệu mẫu.

\subsection{Tạo bảng và các ràng buộc (Constraints)}

\cach Các bảng dữ liệu được tạo theo thứ tự để đảm bảo tính toàn vẹn tham chiếu (tạo bảng cha trước, bảng con sau). Các ràng buộc miền giá trị (Domain Constraints) được cài đặt trực tiếp bằng từ khóa \texttt{CHECK}.
% Bảng CINEMA và ROOM
\subsubsection{Bảng Rạp chiếu (CINEMA) và Phòng chiếu (ROOM)}
\cach Bảng \texttt{CINEMA} lưu trữ thông tin các cụm rạp. Bảng \texttt{ROOM} lưu trữ thông tin phòng chiếu, có ràng buộc sức chứa (\texttt{Capacity}) phải lớn hơn 0 và loại phòng (\texttt{RoomType}) thuộc tập quy định.
\begin{lstlisting}
CREATE TABLE CINEMA (
    CinemaID VARCHAR(10) PRIMARY KEY,
    Name NVARCHAR(100) NOT NULL,
    Hotline VARCHAR(15),
    Address NVARCHAR(200)
);

CREATE TABLE ROOM (
    Room_ID VARCHAR(10) PRIMARY KEY,
    CinemaID VARCHAR(10) NOT NULL,
    RoomName NVARCHAR(50) NOT NULL,
    RoomType NVARCHAR(20), 
    Capacity INT NOT NULL,
    
    FOREIGN KEY (CinemaID) REFERENCES CINEMA(CinemaID),
    CONSTRAINT CK_Room_Capacity CHECK (Capacity > 0),
    CONSTRAINT CK_Room_Type CHECK (RoomType IN ('2D', '3D', 'IMAX', '4DX', 'Gold Class', 'Sweetbox', 'VIP')),
);
\end{lstlisting}
% Bảng SEAT
\subsubsection{Bảng Ghế (SEAT)}
\cach Bảng \texttt{SEAT} lưu trữ thông tin ghế trong phòng chiếu, có ràng buộc hạng ghế (\texttt{SeatType}) thuộc tập quy định và thông tin ghế (\texttt{SeatInfo}) phải có định dạng gồm một chữ cái và các số.
\begin{lstlisting}
	CREATE TABLE SEAT (
    Room_ID VARCHAR(10),
    SeatInfo VARCHAR(10), 
    SeatType NVARCHAR(20) NOT NULL,
    
    PRIMARY KEY (Room_ID, SeatInfo),
    FOREIGN KEY (Room_ID) REFERENCES ROOM(Room_ID),
    CONSTRAINT CK_Seat_Type CHECK (SeatType IN ('Standard', 'VIP', 'Couple', 'Deluxe')),
    CONSTRAINT CK_Seat_SeatInfo CHECK (SeatInfo LIKE '[A-Z]%' AND ISNUMERIC(SUBSTRING(SeatInfo, 2, LEN(SeatInfo) - 1)) = 1)
);
\end{lstlisting}
% Bảng USER và MOVIE
\subsubsection{Bảng Khách hàng (USER) và Phim (MOVIE)}
\cach Bảng \texttt{USER} có các ràng buộc quan trọng về định dạng số điện thoại, mật khẩu phức tạp và độ tuổi. Bảng \texttt{MOVIE} kiểm tra thời lượng phim phải là số dương và giới hạn độ tuổi hợp lệ.
\begin{lstlisting}
CREATE TABLE [USER] (
    UserID VARCHAR(10) PRIMARY KEY,
    FirstName NVARCHAR(50) NOT NULL,
    LastName NVARCHAR(50) NOT NULL,
    Email VARCHAR(100) UNIQUE NOT NULL,
    Phone VARCHAR(15) NOT NULL,
    Password VARCHAR(50) NOT NULL,
    Birthday DATE,
    Gender NVARCHAR(10),
    CreatedAt DATETIME DEFAULT GETDATE(),

    CONSTRAINT CK_User_Phone CHECK (LEN(Phone) = 10 AND ISNUMERIC(Phone) = 1),
    CONSTRAINT CK_User_Gender CHECK (Gender IN ('Male', 'Female')),
    CONSTRAINT CK_User_Birthday CHECK (Birthday < GETDATE()),
    CONSTRAINT CK_User_Password CHECK (
        LEN(Password) >= 8 AND 
        Password COLLATE Latin1_General_BIN LIKE '%[A-Z]%' AND 
        Password COLLATE Latin1_General_BIN LIKE '%[0-9]%' AND 
        Password COLLATE Latin1_General_BIN LIKE '%[@$#%!&]%'
    )
);

CREATE TABLE MOVIE (
    Movie_ID VARCHAR(10) PRIMARY KEY,
    Title NVARCHAR(100) NOT NULL,
    Duration INT NOT NULL,
    ReleaseDate DATE NOT NULL,
    Description NVARCHAR(MAX),
    Poster VARCHAR(200), 
    Trailer VARCHAR(200), 
    Language NVARCHAR(30),
    AgeRating VARCHAR(5), 
    Director NVARCHAR(50),
    Prequel_ID VARCHAR(10), 

    FOREIGN KEY (Prequel_ID) REFERENCES MOVIE(Movie_ID),
    CONSTRAINT CK_Movie_Duration CHECK (Duration > 0),
    CONSTRAINT CK_Movie_AgeRating CHECK (AgeRating IN ('P', 'T13', 'T16', 'T18', 'K') )
);
\end{lstlisting}
% Bảng GENRE và ACTOR
\subsubsection{Bảng Thể loại phim (Genre) và Diễn viên (Actor)}
\cach Bảng \texttt{Genre} và bảng \texttt{Actor} lưu trữ thông tin thể loại phim và diễn viên, có ràng buộc thể loại thuộc tập quy định.
\begin{lstlisting}
CREATE TABLE GENRE (
    Movie_ID VARCHAR(10),
    Genre NVARCHAR(50),
    PRIMARY KEY (Movie_ID, Genre),
    FOREIGN KEY (Movie_ID) REFERENCES MOVIE(Movie_ID),
    CONSTRAINT CK_Genre_Type CHECK (Genre IN ('Action', 'Comedy', 'Drama', 'Horror', 'Romance', 'Sci-Fi', 'Documentary', 'Animation', 'Thriller', 'Fantasy', 'Adventure', 'Musical', 'Biography', 'Crime', 'Family', 'Mystery', 'War', 'Western', 'Sport', 'History', 'Mysterious', 'Mythical') )
);

CREATE TABLE ACTOR (
    Movie_ID VARCHAR(10),
    Actor NVARCHAR(50),
    PRIMARY KEY (Movie_ID, Actor),
    FOREIGN KEY (Movie_ID) REFERENCES MOVIE(Movie_ID)
);
\end{lstlisting}
% Bảng SHOWTIME và PAYMENT
\subsubsection{Bảng Suất chiếu (SHOWTIME) và Thanh toán (PAYMENT)}
\cach Bảng \texttt{SHOWTIME} chứa thông tin suất chiếu và các ràng buộc quan trọng: Giờ bắt đầu phải nhỏ hơn giờ kết thúc và giá vé phải dương và suất chiếu không được trùng lấp trong cùng một phòng và thời gian suất chiếu (EndTime - StartTime) phải lớn hơn hoặc bằng thời lượng gốc của bộ phim (sẽ được kiểm tra bằng Trigger). Bảng \texttt{PAYMENT} quản lý thông tin thanh toán với ràng buộc trạng thái thanh toán \texttt{PaymentStatus} phải thuộc tập quy định và thời gian thanh toán phải sau thời gian đặt vé và thời gian thanh toán phải trong vòng 24h kể từ thời gian đặt vé (sẽ được kiểm tra bằng Trigger).
\begin{lstlisting}
CREATE TABLE SHOWTIME (
    Showtime_ID VARCHAR(10) PRIMARY KEY,
    Movie_ID VARCHAR(10) NOT NULL,
    Room_ID VARCHAR(10) NOT NULL,
    BasePrice DECIMAL(18, 2) NOT NULL,
    StartTime DATETIME NOT NULL,
    EndTime DATETIME NOT NULL,

    FOREIGN KEY (Movie_ID) REFERENCES MOVIE(Movie_ID),
    FOREIGN KEY (Room_ID) REFERENCES ROOM(Room_ID),
    CONSTRAINT CK_Showtime_Price CHECK (BasePrice > 0),
    CONSTRAINT CK_Showtime_Time CHECK (StartTime < EndTime)
);

CREATE TABLE PAYMENT (
    Payment_ID VARCHAR(10) PRIMARY KEY,
    PaymentTime DATETIME,
    Status NVARCHAR(20) -- Success, Pending, Failed
    CONSTRAINT CK_Payment_Status CHECK (Status IN ('Success', 'Pending', 'Failed') )
);

\end{lstlisting}
% Bảng EMPLOYEE, STAFF, MANAGER
\subsubsection{Bảng Nhân viên tổng quát (EMPLOYEE), Nhân viên (STAFF) và Quản lý (MANAGER)}
\cach Bảng \texttt{EMPLOYEE} lưu trữ thông tin chung của nhân viên. Bảng \texttt{STAFF} và bảng \texttt{MANAGER} kế thừa từ bảng \texttt{EMPLOYEE} để lưu trữ thông tin riêng biệt của từng loại nhân viên, có ràng buộc lương thưởng phải dương và ca làm việc thuộc tập quy định. Bảng \texttt{MANAGER} có ràng buộc số lượng nhân viên quản lý phải lớn hơn hoặc bằng 0. Bảng \texttt{STAFF} có ràng buộc vị trí làm việc thuộc tập quy định.
\begin{lstlisting}
CREATE TABLE EMPLOYEE (
    EmployeeID VARCHAR(10) PRIMARY KEY,
    Cinema_ID VARCHAR(10) NOT NULL,
    FirstName NVARCHAR(50),
    LastName NVARCHAR(50),
    Shift NVARCHAR(20),
    Salary DECIMAL(18, 2),

    FOREIGN KEY (Cinema_ID) REFERENCES CINEMA(CinemaID),
    CONSTRAINT CK_Employee_Salary CHECK (Salary > 0),
    CONSTRAINT CK_Employee_Shift CHECK (Shift IN ('Morning', 'Afternoon', 'Evening'))
);

CREATE TABLE STAFF (
    Staff_ID VARCHAR(10) PRIMARY KEY,
    Position NVARCHAR(50),
    FOREIGN KEY (Staff_ID) REFERENCES EMPLOYEE(EmployeeID),
    CONSTRAINT CK_Staff_Position CHECK (Position IN ('Cashier', 'Usher', 'Cleaner', 'Technician', 'FoodService'))
);

CREATE TABLE MANAGER (
    Manager_ID VARCHAR(10) PRIMARY KEY,
    Num_of_staff INT,
    FOREIGN KEY (Manager_ID) REFERENCES EMPLOYEE(EmployeeID),
    CONSTRAINT CK_Manage_Staff CHECK (Num_of_staff >= 0)
);
\end{lstlisting}
% Bảng BOOKING
\subsubsection{Bảng Đặt vé (BOOKING)}
\cach Bảng \texttt{BOOKING} lưu trữ thông tin đặt vé, có ràng buộc thời gian đặt vé phải trước thời gian bắt đầu suất chiếu (sẽ được kiểm tra bằng Trigger).
\begin{lstlisting}
CREATE TABLE BOOKING (
    Booking_ID VARCHAR(10) PRIMARY KEY,
    UserID VARCHAR(10) NOT NULL,
    PaymentID VARCHAR(10) UNIQUE, -- 1-1 Relationship
    Staff_ID VARCHAR(10), 
    TotalPrice DECIMAL(18, 2),
    BookingTime DATETIME DEFAULT GETDATE(),

    FOREIGN KEY (UserID) REFERENCES [USER](UserID),
    FOREIGN KEY (PaymentID) REFERENCES PAYMENT(Payment_ID),
    FOREIGN KEY (Staff_ID) REFERENCES STAFF(Staff_ID)
);
\end{lstlisting}
\subsubsection{Bảng Khuyến mãi (VOUCHER), Điều kiện áp dụng voucher (CONDITION), Áp dụng voucher (APPLY\_FOR)}
\cach Bảng \texttt{VOUCHER} lưu trữ thông tin voucher khuyến mãi với các ràng buộc về ngày bắt đầu và kết thúc và thuộc tính \texttt{DiscountType} phải thuộc tập quy định. Bảng \texttt{CONDITION} lưu trữ các điều kiện áp dụng voucher. Bảng \texttt{APPLY\_FOR} thể hiện mối quan hệ nhiều-nhiều giữa bảng \texttt{BOOKING} và bảng \texttt{VOUCHER}.
\begin{lstlisting}
CREATE TABLE VOUCHER (
    Promo_Code VARCHAR(20) PRIMARY KEY,
    StartDate DATETIME NOT NULL,
    EndDate DATETIME NOT NULL,
    DiscountType NVARCHAR(20), -- Percent, Fixed
    Percentage FLOAT,
    FixedAmount DECIMAL(18, 2),
    CONSTRAINT CK_Voucher_Date CHECK (StartDate < EndDate),
    CONSTRAINT CK_Voucher_DiscountType CHECK (DiscountType IN ('Percent', 'Fixed'))
);

CREATE TABLE CONDITION (
    Promo_Code VARCHAR(20),
    Condition NVARCHAR(200),
    PRIMARY KEY (Promo_Code, Condition),
    FOREIGN KEY (Promo_Code) REFERENCES VOUCHER(Promo_Code)
);

CREATE TABLE APPLY_FOR (
    Promo_Code VARCHAR(20),
    Booking_ID VARCHAR(10),
    PRIMARY KEY (Promo_Code, Booking_ID),
    FOREIGN KEY (Promo_Code) REFERENCES VOUCHER(Promo_Code),
    FOREIGN KEY (Booking_ID) REFERENCES BOOKING(Booking_ID)
);
\end{lstlisting}
% Bảng F&B, INCLUDE_SEAT
\subsubsection{Bảng Đồ ăn \& Nước uống (F\&B) và Chi tiết đặt ghế (INCLUDE\_SEAT)}
\cach Bảng \texttt{F\&B} lưu trữ thông tin đồ ăn và nước uống với ràng buộc giá tiền phải dương. Bảng \texttt{INCLUDE\_SEAT} thể hiện mối quan hệ 1 - 1 - nhiều giữa bảng \texttt{BOOKING}, bảng \texttt{SHOWTIME} và bảng \texttt{SEAT} với ràng buộc \texttt{SeatStatus} phải thuộc tập quy định.
\begin{lstlisting}
CREATE TABLE F_B (
    FB_ID VARCHAR(10),
    Booking_ID VARCHAR(10),
    FBName NVARCHAR(50),
    Price DECIMAL(18, 2),

    PRIMARY KEY (FB_ID, Booking_ID),
    FOREIGN KEY (Booking_ID) REFERENCES BOOKING(Booking_ID),
    CONSTRAINT CK_FB_Price CHECK (Price > 0)
);

CREATE TABLE INCLUDE_SEAT (
	Room_ID VARCHAR(10),
    SeatInfo VARCHAR(10),
    Showtime_ID VARCHAR(10),
    Booking_ID VARCHAR(10),
    SeatStatus NVARCHAR(20), -- Booked, Sold
	
    PRIMARY KEY (Room_ID, SeatInfo, Showtime_ID),
    FOREIGN KEY (Room_ID, SeatInfo) REFERENCES SEAT(Room_ID, SeatInfo),
    FOREIGN KEY (Showtime_ID) REFERENCES SHOWTIME(Showtime_ID),
    FOREIGN KEY (Booking_ID) REFERENCES BOOKING(Booking_ID),
    CONSTRAINT CK_IncludeSeat_Status CHECK (SeatStatus IN ('Booked', 'Sold'))
	);
\end{lstlisting}
% Bảng MANAGE_MOVIE, MANAGE_SHOWTIME, MANAGE_ROOM
\subsubsection{Bảng Quản lý phim (MANAGE\_MOVIE), Quản lý suất chiếu (SCHEDULE) và Quản lý phòng chiếu (MANAGE\_ROOM)}
\cach Bảng \texttt{MANAGE\_MOVIE}, bảng \texttt{SCHEDULE} và bảng \texttt{MANAGE\_ROOM} lưu trữ thông tin quản lý phim, suất chiếu và phòng chiếu tương ứng. Được thực hiện bởi các quản lý rạp với các ràng buộc về loại hành động (\texttt{ActionType}) và loại điều chỉnh (\texttt{Format}) phải thuộc tập quy định.
\begin{lstlisting}
CREATE TABLE MANAGE_MOVIE (
    Movie_ID VARCHAR(10),
    Manager_ID VARCHAR(10),
    ActionType NVARCHAR(50),
    ActionDate DATETIME,

    PRIMARY KEY (Movie_ID, Manager_ID, ActionDate),
    FOREIGN KEY (Movie_ID) REFERENCES MOVIE(Movie_ID),
    FOREIGN KEY (Manager_ID) REFERENCES MANAGER(Manager_ID),
    CONSTRAINT CK_ManageMovie_ActionType CHECK (ActionType IN ('Add', 'Update', 'Remove'))
);

CREATE TABLE MANAGE_ROOM (
    Room_ID VARCHAR(10),
    Manager_ID VARCHAR(10),
    ActionType NVARCHAR(50),
    ActionDate DATETIME,

    PRIMARY KEY (Room_ID, Manager_ID, ActionDate),
    FOREIGN KEY (Room_ID) REFERENCES ROOM(Room_ID),
    FOREIGN KEY (Manager_ID) REFERENCES MANAGER(Manager_ID),
    CONSTRAINT CK_ManageRoom_ActionType CHECK (ActionType IN ('Add', 'Update', 'Remove'))
);

CREATE TABLE SCHEDULE (
    Showtime_ID VARCHAR(10) PRIMARY KEY,
    Manager_ID VARCHAR(10),
    Format NVARCHAR(20),
    ScheduleDate DATE,
    DurationAdjust INT,
    PriceAdjust DECIMAL(18, 2),

    FOREIGN KEY (Showtime_ID) REFERENCES SHOWTIME(Showtime_ID),
    FOREIGN KEY (Manager_ID) REFERENCES MANAGER(Manager_ID)
);
\end{lstlisting}
\subsubsection{Bảng Bán vé (SELL)}
% Bảng SELL
\cach Bảng \texttt{SELL} lưu trữ thông tin bán vé (thời điểm bán vé, trạng thái in của vé).
\begin{lstlisting}
CREATE TABLE SELL (
    Booking_ID VARCHAR(10) PRIMARY KEY,
    Staff_ID VARCHAR(10),
    PrintStatus BIT,
    SaleTime DATETIME,

    FOREIGN KEY (Booking_ID) REFERENCES BOOKING(Booking_ID),
    FOREIGN KEY (Staff_ID) REFERENCES STAFF(Staff_ID)
);
\end{lstlisting}
% Bảng HANDLE
\subsubsection{Bảng Xử lý (HANDLE)}
\cach Bảng \texttt{HANDLE} lưu trữ thông tin xử lý thanh toán.
\begin{lstlisting}
CREATE TABLE HANDLE (
    Payment_ID VARCHAR(10),
    Staff_ID VARCHAR(10),
    ProcessDate DATETIME,

    PRIMARY KEY (Payment_ID, Staff_ID),
    FOREIGN KEY (Payment_ID) REFERENCES PAYMENT(Payment_ID),
    FOREIGN KEY (Staff_ID) REFERENCES STAFF(Staff_ID),
);
\end{lstlisting}
% Bảng MANAGE_ROOM_STATUS
\subsubsection{Bảng Xử lý (MANAGE\_ROOM\_STATUS)}
\cach Bảng \texttt{MANAGE\_ROOM\_STATUS} lưu trữ thông tin phân công nhân viên quản lý phòng chiếu.
\begin{lstlisting}
CREATE TABLE MANAGE_ROOM_STATUS (
    Room_ID VARCHAR(10),
    Staff_ID VARCHAR(10),
    UpdateTime DATETIME,
    
    PRIMARY KEY (Room_ID, Staff_ID, UpdateTime),
    FOREIGN KEY (Room_ID) REFERENCES ROOM(Room_ID),
    FOREIGN KEY (Staff_ID) REFERENCES STAFF(Staff_ID)
);
\end{lstlisting}
\subsection{Tạo dữ liệu mẫu}
\cach Để kiểm chứng tính đúng đắn của thiết kế CSDL và hoạt động của các ràng buộc toàn vẹn, nhóm đã xây dựng một bộ dữ liệu mẫu mô phỏng hệ thống rạp phim CGV thực tế tại TP.HCM.
\subsection{Mô tả dữ liệu chi tiết}

\subsubsection{Hệ thống Rạp và Phòng chiếu}
Hệ thống bao gồm 10 cụm rạp CGV lớn tại TP.HCM. Mỗi rạp có các loại phòng chiếu đa dạng (IMAX, 4DX, Sweetbox, Gold Class).

\begin{lstlisting}[caption={Dữ liệu Rạp và Phòng chiếu}]
-- Insert Rap CGV
INSERT INTO CINEMA (CinemaID, Name, Hotline, Address) VALUES 
('CN001', N'CGV Vincom Dong Khoi', '19006017', N'72 Le Thanh Ton...'),
('CN002', N'CGV Landmark 81', '19006017', N'772 Dien Bien Phu...');

-- Insert Phong chieu voi suc chua va loai phong cu the
INSERT INTO ROOM (Room_ID, CinemaID, RoomName, RoomType, Capacity) VALUES 
('R001', 'CN001', N'Cinema 1', 'IMAX', 250),
('R005', 'CN003', N'Cinema 1', 'Gold Class', 80);
\end{lstlisting}

\subsubsection{Người dùng và Nhân sự}
\begin{itemize}
	\item \textbf{Khách hàng (User):} Bao gồm 23 tài khoản, trong đó có tích hợp thông tin của các thành viên trong nhóm thực hiện đề tài (US019 - US023) để phục vụ demo.
	\item \textbf{Nhân viên (Employee):} Phân chia rõ ràng giữa cấp Quản lý (Manager) và Nhân viên (Staff) với các ca làm việc (Shift) và mức lương khác nhau.
\end{itemize}

\begin{lstlisting}
-- Insert Thanh vien nhom
INSERT INTO [USER] (UserID, FirstName, LastName, Email...) VALUES 
('US019', N'Nguyen', N'Phu Vinh', 'svPV@gmail.com'... ),
('US023', N'Le', N'Minh Tri', 'svLMT@gmail.com'... );

-- Phan cap Nhan vien va Quan ly
INSERT INTO EMPLOYEE (EmployeeID, Shift, Salary...) VALUES ('EM001', 'Morning', 5000000...);
INSERT INTO MANAGER (Manager_ID, Num_of_staff) VALUES ('EM001', 10);
INSERT INTO STAFF (Staff_ID, Position) VALUES ('EM002', 'Cashier');
\end{lstlisting}

\subsubsection{Phim và Lịch chiếu}
Dữ liệu phim bao gồm đầy đủ thông tin về Đạo diễn, Diễn viên, Thể loại và giới hạn độ tuổi. Đặc biệt có Series phim "Lật Mặt" từ phần 1 đến phần 8 để kiểm tra truy vấn phim theo series (Prequel).

\begin{lstlisting}
INSERT INTO MOVIE (Movie_ID, Title, Duration, AgeRating...) VALUES 
('MV001', N'Mai', 131, 'T18'...),
('MV002', N'Dune: Part Two', 166, 'T16'...),
('MV018', N'Lat Mat 7: Mot Dieu Uoc', 105, 'P'...);

INSERT INTO GENRE (Movie_ID, Genre) VALUES 
('MV001', 'Drama'),
('MV002', 'Sci-Fi'),
('MV018', 'Action');

INSERT INTO ACTOR (Movie_ID, Actor) VALUES 
('MV001', N'Tran Nghia'),
('MV002', N'Timothee Chalamet'),
('MV018', N'Thanh Loc');

INSERT INTO SHOWTIME (Showtime_ID, Movie_ID, Room_ID, BasePrice, StartTime, EndTime) VALUES 
('ST001', 'MV001', 'R001', 120000, '2024-07-01 14:00', '2024-07-01 16:11'),
('ST002', 'MV002', 'R002', 150000, '2024-07-01 17:00', '2024-07-01 19:46');

\end{lstlisting}

\subsubsection{Giao dịch Đặt vé (Transaction Flow)}
Đây là phần phức tạp nhất, mô phỏng quy trình nghiệp vụ trọn vẹn:
\begin{enumerate}
	\item Khách hàng chọn Suất chiếu (\texttt{SHOWTIME}).
	\item Chọn Ghế (\texttt{INCLUDE\_SEAT}) và Combo bắp nước (\texttt{F\_B}).
	\item Áp dụng mã giảm giá (\texttt{VOUCHER} - ví dụ: SUMMER2024, TET2024).
	\item Thanh toán (\texttt{PAYMENT} - Tiền mặt hoặc Thẻ).
\end{enumerate}

\begin{lstlisting}
-- 1. Tao Giao dich Payment truoc
INSERT INTO PAYMENT (Payment_ID, Status) VALUES ('PM001', 'Success');

INSERT INTO CASH (Payment_ID, RefundAmount) VALUES 
('PM001', 0), ('PM002', 0), ('PM003', 0), ('PM004', 0), ('PM009', 0);

INSERT INTO CARD (Payment_ID, PaymentCode, BankName, CardNumber) VALUES 
('PM005', 'TXN005', 'ACB', '9704123456790'),
('PM006', 'TXN006', 'Vietcombank', '9704123456789'),

-- 2. Tao Booking ket noi User va Payment
INSERT INTO BOOKING (Booking_ID, UserID, PaymentID...) VALUES 
('BK001', 'US001', 'PM001'...);

-- 3. Chi tiet Ghe va Do an
INSERT INTO INCLUDE_SEAT (Room_ID, SeatInfo, Booking_ID...) VALUES 
('R001', 'A1', 'BK001'...);
INSERT INTO F_B (FB_ID, Booking_ID, FBName...) VALUES 
('CB01', 'BK001', N'Combo Popcorn Solo'...);

-- 4. Ap dung Voucher
INSERT INTO APPLY_FOR (Promo_Code, Booking_ID) VALUES ('TET2024', 'BK001');
\end{lstlisting}
\subsubsection{Các hoạt động của MANAGER}
\cach Dữ liệu ghi nhận các hoạt động quản lý của các quản lý rạp, bao gồm thêm, sửa, xóa phim và phòng chiếu, cũng như điều chỉnh lịch chiếu.
\begin{lstlisting}
--Bang Manage_Movie
INSERT INTO MANAGE_MOVIE (Movie_ID, Manager_ID, ActionType, ActionDate) VALUES 
('MV001', 'EM004', 'Add', '2024-01-20 08:00:00'),
('MV002', 'EM004', 'Add', '2024-02-15 09:00:00'),
('MV003', 'EM006', 'Add', '2024-02-20 10:00:00'),
('MV004', 'EM004', 'Update', '2024-03-16 11:00:00'),

--Bang Manage_Room
INSERT INTO MANAGE_ROOM (Room_ID, Manager_ID, ActionType, ActionDate) VALUES 
('R001', 'EM001', 'Add', '2021-12-01 08:00:00'),
('R002', 'EM001', 'Add', '2021-12-01 09:00:00'),
('R003', 'EM004', 'Add', '2021-01-10 10:00:00'),
('R005', 'EM006', 'Add', '2020-11-15 08:00:00'),


--Bang Schedule
INSERT INTO SCHEDULE (Showtime_ID, Manager_ID, Format, ScheduleDate, DurationAdjust, PriceAdjust) VALUES 
('SH001', 'EM001', '2D', '2024-02-10', 0, 0),
('SH002', 'EM001', '2D', '2024-02-10', 0, 10000),
('SH003', 'EM001', 'IMAX', '2024-02-25', 0, 20000),
('SH004', 'EM004', '3D', '2024-03-05', 0, 0),
\end{lstlisting}

\subsubsection{Các hoạt động của Nhân viên}
\cach Dữ liệu ghi nhận các hoạt động của nhân viên trong việc xử lý thanh toán và bán vé cho khách hàng. Đồng thời, quản lý phòng chiếu.
\begin{lstlisting}
INSERT INTO SELL (Booking_ID, Staff_ID, PrintStatus, SaleTime) VALUES 
('BK001', 'EM003', 1, '2024-02-14 16:55:00'),
('BK002', 'EM003', 1, '2024-02-14 20:25:00'),
('BK003', 'EM003', 1, '2024-03-02 18:25:00'),
('BK004', 'EM002', 1, '2024-03-09 09:25:00'),
('BK009', 'EM007', 1, '2024-07-27 18:05:00');

INSERT INTO HANDLE (Payment_ID, Staff_ID, ProcessDate) VALUES 
('PM001', 'EM003', '2024-02-14 17:00:00'),
('PM002', 'EM003', '2024-02-14 20:30:00'),
('PM003', 'EM003', '2024-03-02 18:30:00'),
('PM004', 'EM002', '2024-03-09 09:30:00'),
('PM009', 'EM007', '2024-07-27 19:30:00');

INSERT INTO MANAGE_ROOM_STATUS (Room_ID, Staff_ID, UpdateTime) VALUES 
('R001', 'EM003', '2024-02-14 16:00:00'),
('R001', 'EM003', '2024-02-14 23:30:00'),
('R002', 'EM003', '2024-03-02 22:00:00'),
('R003', 'EM002', '2024-03-09 12:00:00'),
('R004', 'EM002', '2024-03-17 01:30:00'),
('R005', 'EM005', '2024-03-30 17:15:00'),
\end{lstlisting}



% Viết thủ tục cho bảng USER
\section{Viết các thủ tục, trigger và hàm}
\subsection{Viết thủ tục cho bảng USER}
\cach Trong phần này, nhóm chúng em sẽ trình bày các thủ tục để thêm (insert), sửa (update) và xóa (delete) dữ liệu vào bảng \texttt{USER} trong cơ sở dữ liệu. Các thủ tục này đều bao gồm việc kiểm tra dữ liệu hợp lệ (validate) để đảm bảo rằng dữ liệu được nhập vào bảng đáp ứng các ràng buộc cụ thể. Đồng thời, các thông báo lỗi cụ thể cũng được xuất ra khi có lỗi, giúp người dùng dễ dàng xác định vấn đề.
\subsubsection{Thủ tục \texttt{sp\_InsertUser}}
\begin{lstlisting}
CREATE PROCEDURE sp_InsertUser
@UserID VARCHAR(10),
@FirstName NVARCHAR(50),
@LastName NVARCHAR(50),
@Email VARCHAR(100),
@Phone VARCHAR(15),
@Password VARCHAR(50),
@Birthday DATE,
@Gender NVARCHAR(10)
AS
BEGIN
SET NOCOUNT ON;
-- 1. Kiem tra trung khoa chinh (UserID)
\begin{lstlisting}
IF EXISTS (SELECT 1 FROM [USER] WHERE UserID = @UserID)
BEGIN
    ;THROW 50001, N'Loi: UserID nay da ton tai trong he thong.', 1;
    RETURN;
END
-- 2. Kiem tra trung Email
IF EXISTS (SELECT 1 FROM [USER] WHERE Email = @Email)
BEGIN
    ;THROW 50002, N'Loi: Email nay da duoc su dung boi tai khoan khac.', 1;
    RETURN;
END
-- 3. Validate So dien thoai (Phai la so va dai 10 ky tu)
IF (LEN(@Phone) <> 10 OR ISNUMERIC(@Phone) = 0)
BEGIN
    ;THROW 50003, N'Loi: So dien thoai khong hop le (Phai bao gom dung 10 chu so).', 1;
    RETURN;
END

-- 4. Validate Mat khau (>= 8 ky tu, co chu hoa, so, ky tu dac biet)
IF (LEN(@Password) < 8 
    OR @Password COLLATE Latin1_General_BIN NOT LIKE '%[A-Z]%' 
    OR @Password COLLATE Latin1_General_BIN NOT LIKE '%[0-9]%' 
    OR @Password COLLATE Latin1_General_BIN NOT LIKE '%[@$#%!&]%')
BEGIN
    ;THROW 50004, N'Loi: Mat khau yeu. Phai co it nhat 8 ky tu, bao gom chu hoa, so va ky tu dac biet (@$#%!&).', 1;
    RETURN;
END

-- 5. Validate Tuoi (Khach hang > 13 tuoi va ngay sinh < thoi diem hien tai)
IF (@Birthday >= GETDATE())
BEGIN
    ;THROW 50005, N'Loi: Ngay sinh khong duoc lon hon ngay hien tai.', 1;
    RETURN;
END

-- 6. Validate Gioi tinh
IF (@Gender NOT IN ('Male', 'Female'))
BEGIN
    ;THROW 50007, N'Loi: Gioi tinh khong hop le (Chi chap nhan "Male" hoac "Female").', 1;
    RETURN;
END

-- Neu tat ca hop le, thuc hien INSERT
INSERT INTO [USER] (UserID, FirstName, LastName, Email, Phone, Password, Birthday, Gender, CreatedAt)
VALUES (@UserID, @FirstName, @LastName, @Email, @Phone, @Password, @Birthday, @Gender, GETDATE());

PRINT N'Them nguoi dung moi thanh cong!';

END;
\end{lstlisting}
\textbf{Giải thích thủ tục:}

\texttt{sp\_InsertUser} là thủ tục dùng để thêm người dùng mới vào bảng \texttt{USER}.

Các kiểm tra đầu tiên đảm bảo rằng \texttt{UserID} và \texttt{Email} không bị trùng lặp trong hệ thống, đảm bảo tính duy nhất của các trường này.

Thủ tục cũng kiểm tra tính hợp lệ của số điện thoại (phải là số và dài 10 ký tự), mật khẩu (ít nhất 8 ký tự, có chữ hoa, số, và ký tự đặc biệt), tuổi của người dùng (ngày sinh không được lớn hơn ngày hiện tại), và giới tính (phải là "Male" hoặc "Female").

Nếu tất cả các điều kiện đều hợp lệ, thủ tục thực hiện thêm thông tin người dùng vào bảng \texttt{USER}.

\noindent\textbf{Testing:}
\begin{lstlisting}
-- Test 1: Them user voi mat khau yeu (Se bao loi 50004)
EXEC sp_InsertUser 'US_TEST', N'Test', N'User', 'test@mail.com', '0901234567', '12345', '2000-01-01', 'Male';

-- Test 2: Them user hop le
EXEC sp_InsertUser 'US_TEST', N'Test', N'User', 'test@mail.com', '0901234567', 'Pass@123', '2000-01-01', 'Male';
\end{lstlisting}

\noindent\textbf{Kết quả:}
\begin{figure}[H]
	\includegraphics[width=1.0\textwidth]{Images/test004_1.png}
	\caption{Kết quả test 1}
	\includegraphics[width=1.0\textwidth]{Images/test004_2.png}
	\includegraphics[width=1.0\textwidth]{Images/test004_2_1.png}
	\caption{Kết quả test 2 và bảng USER sau khi thêm user thành công}
\end{figure}

\subsubsection{Thủ tục \texttt{sp\_UpdateUser}}
\begin{lstlisting}
CREATE PROCEDURE sp_UpdateUser
@UserID VARCHAR(10),
@NewEmail VARCHAR(100),
@NewPhone VARCHAR(15),
@NewPassword VARCHAR(50)
AS
BEGIN
SET NOCOUNT ON;
-- 1. Kiem tra UserID co ton tai khong
IF NOT EXISTS (SELECT 1 FROM [USER] WHERE UserID = @UserID)
BEGIN
    ;THROW 50008, N'Loi: Khong tim thay UserID can cap nhat.', 1;
    RETURN;
END

-- 2. Validate Email moi: Khong duoc trung voi user khac (nhung duoc trung voi chinh minh)
IF EXISTS (SELECT 1 FROM [USER] WHERE Email = @NewEmail AND UserID <> @UserID)
BEGIN
    ;THROW 50009, N'Loi: Email moi da thuoc ve mot tai khoan khac.', 1;
    RETURN;
END

-- 3. Validate Phone moi
IF (LEN(@NewPhone) <> 10 OR ISNUMERIC(@NewPhone) = 0)
BEGIN
    ;THROW 50010, N'Loi: So dien thoai moi khong hop le.', 1;
    RETURN;
END

-- 4. Validate Password moi
IF (LEN(@NewPassword) < 8 
    OR @NewPassword COLLATE Latin1_General_BIN NOT LIKE '%[A-Z]%' 
    OR @NewPassword COLLATE Latin1_General_BIN NOT LIKE '%[0-9]%' 
    OR @NewPassword COLLATE Latin1_General_BIN NOT LIKE '%[@$#%!&]%')
BEGIN
    ;THROW 50011, N'Loi: Mat khau moi khong du manh.', 1;
    RETURN;
END

-- Thuc hien UPDATE
UPDATE [USER]
SET Email = @NewEmail,
    Phone = @NewPhone,
    Password = @NewPassword
WHERE UserID = @UserID;

PRINT N'Cap nhat thong tin nguoi dung thanh cong!';

END;
\end{lstlisting}
\textbf{Giải thích thủ tục:}

\texttt{sp\_UpdateUser} là thủ tục dùng để cập nhật thông tin người dùng.

Thủ tục kiểm tra sự tồn tại của \texttt{UserID}, đảm bảo rằng người dùng cần cập nhật phải tồn tại trong cơ sở dữ liệu.

Sau đó, thủ tục kiểm tra tính hợp lệ của \texttt{Email} (không được trùng với tài khoản khác), \texttt{Phone} (phải là số và đủ 10 chữ số) và \texttt{Password} (phải đủ mạnh, bao gồm chữ hoa, số và ký tự đặc biệt).

Nếu tất cả các kiểm tra hợp lệ, thủ tục thực hiện cập nhật thông tin của người dùng trong bảng \texttt{USER}.

\noindent\textbf{Testing:}
\begin{lstlisting}
-- Test 3: Cap nhat thong tin cua userID khong ton tai (That bai)
EXEC sp_UpdateUser 'US_100', 'abc@gmail.com', '0901122334', 'StrongPass1@';

-- Test 4: Cap nhat thong tin hop le
EXEC sp_UpdateUser 'US_TEST', 'newemail@mail.com', '0908765432', 'NewPass@123';
\end{lstlisting}

\noindent\textbf{Kết quả:}
\begin{figure}[H]
	\includegraphics[width=1.0\textwidth]{Images/test004_3.png}
	\caption{Kết quả test 3}
	\includegraphics[width=1.0\textwidth]{Images/test004_4.png}
	\includegraphics[width=1.0\textwidth]{Images/test004_4_1.png}
	\caption{Kết quả test 4 và UserID: "US\_TEST" sau khi cập nhật thành công}
\end{figure}

\subsubsection{Thủ tục \texttt{sp\_DeleteUser}}
\begin{lstlisting}
CREATE PROCEDURE sp_DeleteUser
@UserID VARCHAR(10)
AS
BEGIN
SET NOCOUNT ON;
-- 1. Kiem tra UserID co ton tai khong
IF NOT EXISTS (SELECT 1 FROM [USER] WHERE UserID = @UserID)
BEGIN
    ;THROW 50012, N'Loi: UserID khong ton tai de xoa.', 1;
    RETURN;
END

-- 2. Kiem tra rang buoc du lieu (Neu User da tung dat ve)
-- Neu User da tung dat ve (ton tai trong bang BOOKING), KHONG DUOC XOA.
IF EXISTS (SELECT 1 FROM BOOKING WHERE UserID = @UserID)
BEGIN
    ;THROW 50013, N'Loi: Khong the xoa nguoi dung nay vi ho da co lich su giao dich (Booking). Hay vo hieu hoa tai khoan nay thay vi xoa.', 1;
    RETURN;
END

-- Neu thoa man dieu kien (chua tung mua ve), thuc hien DELETE
DELETE FROM [USER]
WHERE UserID = @UserID;

PRINT N'Xoa nguoi dung thanh cong!';

END;
\end{lstlisting}
\textbf{Giải thích thủ tục:}

\texttt{sp\_DeleteUser} là thủ tục dùng để xóa người dùng khỏi bảng \texttt{USER}.

Thủ tục đầu tiên kiểm tra sự tồn tại của \texttt{UserID}.

Nếu người dùng đã từng thực hiện giao dịch (có lịch sử trong bảng \texttt{BOOKING}), thủ tục không cho phép xóa và xuất ra thông báo lỗi.

Nếu người dùng chưa thực hiện giao dịch nào, thủ tục thực hiện xóa người dùng khỏi bảng \texttt{USER}.

\noindent\textbf{Testing:}
\begin{lstlisting}
-- Test 5: Xoa user US001 (That bai vi US001 da co Booking trong du lieu mau truoc do)
EXEC sp_DeleteUser 'US001';

-- Test 6: Xoa user vua tao (Thanh cong vi chua mua ve)
EXEC sp_DeleteUser 'US_TEST';
\end{lstlisting}

\noindent\textbf{Kết quả:}
\begin{figure}[H]
	\includegraphics[width=1.0\textwidth]{Images/test004_5.png}
	\caption{Kết quả test 5}
	\includegraphics[width=1.0\textwidth]{Images/test004_6.png}
	\includegraphics[width=1.0\textwidth]{Images/test004_6_1.png}
	\caption{Kết quả test 6 và bảng USER sau khi xóa user thành công}
\end{figure}

\subsection*{Mục đích và Tại sao cần kiểm tra?}

\textbf{Mục đích của thủ tục:} Các thủ tục này nhằm đảm bảo tính toàn vẹn của dữ liệu trong bảng \texttt{USER}, đồng thời đảm bảo rằng các thông tin người dùng được nhập vào hệ thống phải hợp lệ và đáp ứng các yêu cầu bảo mật như mật khẩu mạnh và thông tin liên lạc chính xác.

\textbf{Kiểm tra dữ liệu:} Việc kiểm tra dữ liệu nhằm phát hiện sớm các lỗi nhập liệu, tránh việc nhập vào các thông tin sai hoặc không hợp lệ, như \texttt{Email} trùng lặp, số điện thoại sai định dạng, hoặc mật khẩu yếu. Các kiểm tra này cũng giúp bảo vệ tính bảo mật và bảo vệ quyền lợi của người dùng trong hệ thống.

\textbf{Lý do cần xóa dữ liệu:} Thủ tục xóa người dùng chỉ thực hiện khi người dùng không có giao dịch lịch sử. Việc này nhằm đảm bảo tính toàn vẹn của dữ liệu và không làm mất các thông tin liên quan đến các giao dịch đã thực hiện.

\subsection{Viết các Trigger}
\subsubsection{Trigger kiểm tra ngày khởi chiếu hợp lệ}
\begin{itemize}
	\item \textbf{1. Ràng buộc nghiệp vụ:} Ngày bắt đầu suất chiếu (\texttt{StartTime}) phải diễn ra sau hoặc cùng ngày với ngày khởi chiếu chính thức (\texttt{ReleaseDate}) của bộ phim.

	\item \textbf{2. Thao tác DML vi phạm:} \texttt{INSERT}, \texttt{UPDATE} trên bảng \texttt{SHOWTIME}.

	\item \textbf{3. Mã lệnh Trigger:}
	      \begin{lstlisting}
CREATE TRIGGER trg_Check_ReleaseDate
ON SHOWTIME
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT 1 FROM INSERTED i
        JOIN MOVIE m ON i.Movie_ID = m.Movie_ID
        WHERE m.ReleaseDate > i.StartTime
    )
    BEGIN
        RAISERROR (N'Loi: Ngay khoi chieu phim phai som hon thoi gian bat dau suat chieu.', 16, 1);
        ROLLBACK TRANSACTION;
    END
END;
GO
\end{lstlisting}

	\item \textbf{4. Dữ liệu minh họa (Test Case):}
	      \begin{lstlisting}
-- Phim MV001 cong chieu 2026. Tao suat chieu nam 2025 -> LOI
INSERT INTO SHOWTIME (Showtime_ID, Movie_ID, Room_ID, BasePrice, StartTime, EndTime)
VALUES ('ST_TEST_1', 'MV001', 'R001', 100000, '2025-12-31 18:00', '2025-12-31 20:00');
\end{lstlisting}

	      \begin{lstlisting}[style=error-terminal]
Msg 50000, Level 16, State 1, Procedure trg_Check_Showtime_Duration_Valid, Line 16
Loi: Thoi gian suat chieu (EndTime - StartTime) ngan hon thoi luong goc cua bo phim.
Msg 3609, Level 16, State 1, Line 1
The transaction ended in the trigger. The batch has been aborted.
\end{lstlisting}

\end{itemize}

\subsubsection{Trigger chống trùng lịch chiếu (Overlap)}
\begin{itemize}
	\item \textbf{1. Ràng buộc nghiệp vụ:} Trong cùng một phòng chiếu (\texttt{Room\_ID}), không được phép có hai suất chiếu chồng chéo thời gian lên nhau.

	\item \textbf{2. Thao tác DML vi phạm:} \texttt{INSERT}, \texttt{UPDATE} trên bảng \texttt{SHOWTIME}.

	\item \textbf{3. Mã lệnh Trigger:}
	      \begin{lstlisting}
CREATE TRIGGER trg_Check_Showtime_Overlap
ON SHOWTIME
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT 1 FROM INSERTED i
        JOIN SHOWTIME s ON i.Room_ID = s.Room_ID
        WHERE i.Showtime_ID <> s.Showtime_ID -- Khong so sanh voi chinh no
          AND (
              (i.StartTime >= s.StartTime AND i.StartTime < s.EndTime)
              OR (i.EndTime > s.StartTime AND i.EndTime <= s.EndTime)
              OR (i.StartTime <= s.StartTime AND i.EndTime >= s.EndTime)
          )
    )
    BEGIN
        RAISERROR (N'Loi: Suat chieu bi trung thoi gian trong cung mot phong.', 16, 1);
        ROLLBACK TRANSACTION;
    END
END;
GO
\end{lstlisting}

	\item \textbf{4. Dữ liệu minh họa (Test Case):}
	      \begin{lstlisting}
-- Tao suat chieu 19:00 - 21:00 chong len suat 18:00 - 20:00 da co -> LOI
INSERT INTO SHOWTIME (Showtime_ID, Movie_ID, Room_ID, BasePrice, StartTime, EndTime)
VALUES ('ST_ERR', 'MV001', 'R001', 100000, '2024-02-14 19:00', '2024-02-14 21:00');
\end{lstlisting}

	      \begin{lstlisting}[style=error-terminal]
Msg 50000, Level 16, State 1, Procedure trg_Check_Showtime_Overlap, Line 22
Loi: Suat chieu bi trung thoi gian trong cung mot phong.
Msg 3609, Level 16, State 1, Line 2
The transaction ended in the trigger. The batch has been aborted.
\end{lstlisting}

\end{itemize}

\subsubsection{Trigger kiểm tra thời gian đặt vé}
\begin{itemize}
	\item \textbf{1. Ràng buộc nghiệp vụ:} Thời gian đặt vé (\texttt{BookingTime}) phải sớm hơn thời gian bắt đầu suất chiếu.
	\item \textbf{2. Thao tác DML vi phạm:} \texttt{INSERT}, \texttt{UPDATE} trên bảng \texttt{INCLUDE\_SEAT}.
	\item \textbf{3. Mã lệnh Trigger:}
	      \begin{lstlisting}
CREATE TRIGGER trg_Check_BookingTime
ON INCLUDE_SEAT
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT 1 FROM INSERTED i
        JOIN BOOKING b ON i.Booking_ID = b.Booking_ID
        JOIN SHOWTIME s ON i.Showtime_ID = s.Showtime_ID
        WHERE b.BookingTime >= s.StartTime
    )
    BEGIN
        RAISERROR (N'Loi: Thoi gian dat ve phai som hon suat chieu.', 16, 1);
        ROLLBACK TRANSACTION;
    END
END;
GO
\end{lstlisting}
	\item \textbf{4. Ví dụ minh họa:}
	      \begin{lstlisting}
INSERT INTO BOOKING(BOOKING_ID, USERID,BOOKINGTIME) VALUES ('BK_TEST_1','US001','2025-11-28 18:00:00');
INSERT INTO INCLUDE_SEAT(ROOM_ID,SEATINFO,SHOWTIME_ID,BOOKING_ID,SEATSTATUS) VALUES ('R010','B2','SH019','BK_TEST_1','Booked');
\end{lstlisting}

	      \begin{lstlisting}[style=error-terminal]
Msg 50000, Level 16, State 1, Procedure trg_Check_BookingTime, Line 16
Loi: Thoi gian dat ve phai som hon thoi gian bat dau suat chieu.
Msg 3609, Level 16, State 1, Line 1
The transaction ended in the trigger. The batch has been aborted.
\end{lstlisting}
\end{itemize}

\subsubsection{Trigger kiểm tra thời gian thanh toán}
\begin{itemize}
	\item \textbf{1. Ràng buộc nghiệp vụ:} Thời gian thanh toán phải diễn ra sau khi đã tạo đơn đặt vé.
	\item \textbf{2. Thao tác DML vi phạm:} \texttt{INSERT}, \texttt{UPDATE} trên bảng \texttt{PAYMENT}.
	\item \textbf{3. Mã lệnh Trigger:}
	      \begin{lstlisting}
CREATE TRIGGER trg_Check_PaymentTime
ON BOOKING
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT 1 
        FROM INSERTED p
        JOIN PAYMENT b ON b.Payment_ID = p.PaymentID
        WHERE p.BookingTime >= b.PaymentTime
    )
    BEGIN
        RAISERROR ('Loi: Thoi gian thanh toan phai sau thoi gian dat ve.', 16, 1);
        ROLLBACK TRANSACTION;
    END
END;
GO
\end{lstlisting}
	\item \textbf{4. Ví dụ minh họa:}
	      \begin{lstlisting}
INSERT INTO BOOKING(BOOKING_ID, USERID, PaymentID,BOOKINGTIME) VALUES ('BK_TEST_1','US001','PMT_TEST_1','2025-11-28 18:00:00');
INSERT INTO PAYMENT(Payment_ID, PaymentTime) VALUES ('PMT_TEST_1','2025-11-28 17:00:00');
\end{lstlisting}

	      \begin{lstlisting}[style=error-terminal]
Msg 50000, Level 16, State 1, Procedure trg_Check_PaymentTime, Line 14
Loi: Thoi gian thanh toan phai sau thoi gian dat ve.
Msg 3609, Level 16, State 1, Line 1
The transaction ended in the trigger. The batch has been aborted.
\end{lstlisting}
\end{itemize}

\subsubsection{Trigger kiểm tra hạn thanh toán trong 24h}
\begin{itemize}
	\item \textbf{1. Ràng buộc nghiệp vụ:} Thanh toán phải thực hiện trong vòng 24 giờ kể từ khi đặt vé.
	\item \textbf{2. Thao tác DML vi phạm:} \texttt{INSERT}, \texttt{UPDATE} trên bảng \texttt{PAYMENT}.
	\item \textbf{3. Mã lệnh Trigger:}
	      \begin{lstlisting}
CREATE TRIGGER trg_Check_Payment_Within_24Hours
ON BOOKING
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT 1 
        FROM INSERTED p
        JOIN PAYMENT b ON p.PaymentID = b.Payment_ID
        WHERE DATEDIFF(HOUR, p.BookingTime, b.PaymentTime) > 24
    )
    BEGIN
        RAISERROR ('Loi: Thoi gian thanh toan phai trong vong 24 gio ke tu thoi gian dat ve.', 16, 1);
        ROLLBACK TRANSACTION;
    END
END;
GO
\end{lstlisting}
	\item \textbf{4. Ví dụ minh họa:}
	      \begin{lstlisting}
INSERT INTO PAYMENT (Payment_ID, PaymentTime)
VALUES ('PM_ERR', '2025-01-10 09:00:00');
INSERT INTO BOOKING (Booking_ID, UserID, PaymentID, BookingTime)
VALUES ('BK_ERR', 'US001', 'PM_ERR', '2025-01-08 10:00:00');
\end{lstlisting}

	      \begin{lstlisting}[style=error-terminal]
Msg 50000, Level 16, State 1, Procedure trg_Check_Payment_Within_24Hours, Line 13
Loi: Thoi gian thanh toan phai trong vong 24 gio ke tu thoi gian dat ve.
Msg 3609, Level 16, State 1, Line 1
The transaction ended in the trigger. The batch has been aborted.
\end{lstlisting}

\end{itemize}

\subsubsection{Trigger kiểm tra thời lượng suất chiếu}
\begin{itemize}
	\item \textbf{1. Ràng buộc nghiệp vụ:} Thời gian chiếu (\texttt{EndTime - StartTime}) phải đủ dài để chiếu hết bộ phim.
	\item \textbf{2. Thao tác DML vi phạm:} \texttt{INSERT}, \texttt{UPDATE} trên bảng \texttt{SHOWTIME}.
	\item \textbf{3. Mã lệnh Trigger:}
	      \begin{lstlisting}
CREATE TRIGGER trg_Check_Showtime_Duration_Valid
ON SHOWTIME
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT 1 FROM INSERTED i
        JOIN MOVIE m ON i.Movie_ID = m.Movie_ID
        WHERE DATEDIFF(MINUTE, i.StartTime, i.EndTime) < m.Duration
    )
    BEGIN
        RAISERROR (N'Loi: Thoi gian suat chieu ngan hon phim.', 16, 1);
        ROLLBACK TRANSACTION;
    END
END;
GO
\end{lstlisting}
	\item \textbf{4. Ví dụ minh họa:}
	      \begin{lstlisting}
INSERT INTO SHOWTIME (Showtime_ID, Movie_ID, Room_ID, BasePrice, StartTime, EndTime)
VALUES ('ST_TEST_2', 'MV001', 'R001', 100000, '2026-01-01 18:00', '2026-01-01 19:00');
\end{lstlisting}

	      \begin{lstlisting}[style=error-terminal]
Msg 50000, Level 16, State 1, Procedure trg_Check_Showtime_Duration_Valid, Line 16
Loi: Thoi gian suat chieu (EndTime - StartTime) ngan hon thoi luong goc cua bo phim.
Msg 3609, Level 16, State 1, Line 1
The transaction ended in the trigger. The batch has been aborted.
\end{lstlisting}

\end{itemize}

\subsubsection{Trigger tính thuộc tính dẫn xuất TotalPrice trong BOOKING}
\begin{itemize}
	\item \textbf{1. Chọn thuộc tính dẫn xuất:} \texttt{TotalPrice} (Tổng tiền cuối cùng) trong bảng \texttt{BOOKING}.

	      \textit{Công thức tính:}
	      \[ TotalPrice = (\sum TienVe + \sum TienFB) - Voucher \]

	\item \textbf{2. Các thao tác DML làm thay đổi giá trị:}
	      Giá trị \texttt{TotalPrice} phụ thuộc vào dữ liệu của 3 bảng khác nhau, do đó cần bắt sự kiện trên cả 3 bảng:
	      \begin{itemize}
		      \item Bảng \texttt{INCLUDE\_SEAT}: \texttt{INSERT}, \texttt{UPDATE}, \texttt{DELETE} (Thay đổi số lượng ghế).
		      \item Bảng \texttt{F\_B}: \texttt{INSERT}, \texttt{UPDATE}, \texttt{DELETE} (Thay đổi dịch vụ ăn uống).
		      \item Bảng \texttt{APPLY\_FOR}: \texttt{INSERT}, \texttt{DELETE} (Áp dụng hoặc gỡ bỏ mã giảm giá).
	      \end{itemize}

	\item \textbf{3. Mã lệnh (Stored Procedure \& Trigger):}

	      \textit{Giải pháp:} Do yêu cầu phải tính tổng tiền hàng (Vé + F\&B) trước thì mới tính được mức giảm giá của Voucher (ví dụ giảm 10\% trên tổng đơn), nên nhóm sử dụng một \textbf{Stored Procedure} trung tâm để xử lý tuần tự logic này, sau đó các Trigger sẽ gọi Procedure đó.

	      \textbf{A. Stored Procedure (Bộ xử lý trung tâm):}
	      \begin{lstlisting}
CREATE PROCEDURE sp_Calculate_Booking_Total
    @BookingID VARCHAR(10)
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @TotalTicket DECIMAL(18, 2) = 0;
    DECLARE @TotalFB DECIMAL(18, 2) = 0;
    DECLARE @Discount DECIMAL(18, 2) = 0;
    DECLARE @FinalPrice DECIMAL(18, 2) = 0;

    -- BUOC 1: Tinh tong tien ve (Cong don tung ve trong INCLUDE_SEAT)
    SELECT @TotalTicket = ISNULL(SUM(ST.BasePrice), 0)
    FROM INCLUDE_SEAT INS JOIN SHOWTIME ST ON INS.Showtime_ID = ST.Showtime_ID
    WHERE INS.Booking_ID = @BookingID;

    -- BUOC 2: Tinh tong tien F&B (Cong don tung mon trong F_B)
    SELECT @TotalFB = ISNULL(SUM(Price), 0) FROM F_B WHERE Booking_ID = @BookingID;

    -- Tong tam tinh (Subtotal) truoc khi giam gia
    DECLARE @SubTotal DECIMAL(18, 2) = @TotalTicket + @TotalFB;

    -- BUOC 3: Xu ly Voucher (Kiem tra logic Apply Voucher)
    IF EXISTS (SELECT 1 FROM APPLY_FOR WHERE Booking_ID = @BookingID)
    BEGIN
        DECLARE @DiscountType NVARCHAR(20), @Percentage FLOAT, @FixedAmount DECIMAL(18, 2), @EndDate DATETIME;
        SELECT TOP 1 
            @DiscountType = V.DiscountType, 
            @Percentage = V.Percentage, 
            @FixedAmount = V.FixedAmount, 
            @EndDate = V.EndDate
        FROM APPLY_FOR AF JOIN VOUCHER V ON AF.Promo_Code = V.Promo_Code
        WHERE AF.Booking_ID = @BookingID;

        IF GETDATE() <= @EndDate 
        BEGIN
            IF @DiscountType = 'Percent' SET @Discount = @SubTotal * (@Percentage / 100.0);
            ELSE IF @DiscountType = 'Fixed' SET @Discount = @FixedAmount;
        END
    END

    -- BUOC 4: Chot gia cuoi cung
    SET @FinalPrice = @SubTotal - @Discount;
    IF @FinalPrice < 0 SET @FinalPrice = 0;

    UPDATE BOOKING SET TotalPrice = @FinalPrice WHERE Booking_ID = @BookingID;
END;
GO
\end{lstlisting}

	      \textbf{B. Các Trigger kích hoạt (Event Listeners):}

	      \textit{Trigger 1: Cập nhật khi thay đổi Ghế (INCLUDE\_SEAT)}
	\item \textbf{Mục đích:} Tự động tính toán và cập nhật lại tổng tiến (TotalPrice) trong bảng Booking bất cứ khi nào có thay đổi liên quan đến danh sách ghế ngồi danh sách ghế ngồi của đơn đặt vé.
	      \begin{lstlisting}
CREATE TRIGGER trg_Update_Total_On_Seat
ON INCLUDE_SEAT
AFTER INSERT, DELETE, UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @BookingList TABLE (ID VARCHAR(10));
    INSERT INTO @BookingList SELECT Booking_ID FROM Inserted UNION SELECT Booking_ID FROM Deleted;

    DECLARE @BookingID VARCHAR(10);
    DECLARE cur CURSOR FOR SELECT ID FROM @BookingList;
    OPEN cur; FETCH NEXT FROM cur INTO @BookingID;
    WHILE @@FETCH_STATUS = 0 BEGIN
        EXEC sp_Calculate_Booking_Total @BookingID;
        FETCH NEXT FROM cur INTO @BookingID;
    END
    CLOSE cur; DEALLOCATE cur;
END;
GO
\end{lstlisting}

	      \textit{Trigger 2: Cập nhật khi thay đổi F\&B (F\_B)}
	\item \textbf{Mục đích:} Tự động tính toán và cập nhật lại tổng tiến (TotalPrice) trong bảng Booking bất cứ khi nào có thay đổi liên quan đến dịch vụ ăn uống (F\&B) của đơn đặt vé.
	      \begin{lstlisting}
CREATE TRIGGER trg_Update_Total_On_FB
ON F_B
AFTER INSERT, DELETE, UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @BookingList TABLE (ID VARCHAR(10));
    INSERT INTO @BookingList SELECT Booking_ID FROM Inserted UNION SELECT Booking_ID FROM Deleted;

    DECLARE @BookingID VARCHAR(10);
    DECLARE cur CURSOR FOR SELECT ID FROM @BookingList;
    OPEN cur; FETCH NEXT FROM cur INTO @BookingID;
    WHILE @@FETCH_STATUS = 0 BEGIN
        EXEC sp_Calculate_Booking_Total @BookingID;
        FETCH NEXT FROM cur INTO @BookingID;
    END
    CLOSE cur; DEALLOCATE cur;
END;
GO
\end{lstlisting}

	      \textit{Trigger 3: Cập nhật khi áp dụng Voucher (APPLY\_FOR)}
	\item \textbf{Mục đích:} Tự động tính toán và cập nhật lại tổng tiến (TotalPrice) trong bảng Booking bất cứ khi nào có thay đổi liên quan đến việc áp dụng hoặc gỡ bỏ mã giảm giá (Voucher) cho đơn đặt vé.
	      \begin{lstlisting}
CREATE TRIGGER trg_Update_Total_On_Voucher
ON APPLY_FOR
AFTER INSERT, DELETE
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @BookingList TABLE (ID VARCHAR(10));
    INSERT INTO @BookingList SELECT Booking_ID FROM Inserted UNION SELECT Booking_ID FROM Deleted;

    DECLARE @BookingID VARCHAR(10);
    DECLARE cur CURSOR FOR SELECT ID FROM @BookingList;
    OPEN cur; FETCH NEXT FROM cur INTO @BookingID;
    WHILE @@FETCH_STATUS = 0 BEGIN
        EXEC sp_Calculate_Booking_Total @BookingID;
        FETCH NEXT FROM cur INTO @BookingID;
    END
    CLOSE cur; DEALLOCATE cur;
END;
GO
\end{lstlisting}

	\item \textbf{4. Dữ liệu minh họa (Test Case):}
	      \begin{lstlisting}
-- 1. Tao mot ghe gia trong phong R001 de test
IF NOT EXISTS (SELECT * FROM SEAT WHERE Room_ID = 'R001' AND SeatInfo = 'T1')
    INSERT INTO SEAT (Room_ID, SeatInfo, SeatType) VALUES ('R001', 'T1', 'Standard');

IF NOT EXISTS (SELECT * FROM SEAT WHERE Room_ID = 'R001' AND SeatInfo = 'T2')
    INSERT INTO SEAT (Room_ID, SeatInfo, SeatType) VALUES ('R001', 'T2', 'Standard');

-- 2. Tao mot Voucher test (Giam 10000)
IF NOT EXISTS (SELECT * FROM VOUCHER WHERE Promo_Code = 'TEST_10PERCENT')
    INSERT INTO VOUCHER (Promo_Code, StartDate, EndDate, DiscountType, FixedAmount)
    VALUES ('TEST_10PERCENT', '2020-01-01', '2030-12-31', 'Fixed', 10000);
\end{lstlisting}

	      \begin{lstlisting}
-- Tao moi
INSERT INTO BOOKING (Booking_ID, UserID, TotalPrice, BookingTime) 
VALUES ('BK_TEST', 'US001', 0, '2024-02-14 14:00:00');
-- Them ghe 1
INSERT INTO INCLUDE_SEAT (Room_ID, SeatInfo, Showtime_ID, Booking_ID, SeatStatus) 
VALUES ('R001', 'T1', 'SH001', 'BK_TEST', 'Booked');

-- Them ghe 2
INSERT INTO INCLUDE_SEAT (Room_ID, SeatInfo, Showtime_ID, Booking_ID, SeatStatus) 
VALUES ('R001', 'T2', 'SH001', 'BK_TEST', 'Booked');

-- Kiem tra gia (Ky vong: 2 ve * 100k = 200,000)
SELECT Booking_ID, TotalPrice AS [Gia Buoc 2 (200k)] FROM BOOKING WHERE Booking_ID = 'BK_TEST';
\end{lstlisting}

	      \begin{figure}[h!]
		      \centering
		      \includegraphics[width=0.4\textwidth]{images/Gia tien 2 ghe.jpg}
		      \caption{Kết quả sau bước 2: TotalPrice = 200,000}
	      \end{figure}

	      \begin{lstlisting}
-- Them 1 Combo gia 50,000
INSERT INTO F_B (FB_ID, Booking_ID, FBName, Price) 
VALUES ('TEST_FB', 'BK_TEST', N'Combo Test', 50000);

-- Kiem tra gia (Ky vong: 200k ve + 50k nuoc = 250,000)
SELECT Booking_ID, TotalPrice AS [Gia Buoc 3 (250k)] FROM BOOKING WHERE Booking_ID = 'BK_TEST';
\end{lstlisting}

	      \begin{figure}[h!]
		      \centering
		      \includegraphics[width=0.4\textwidth]{images/Gia tien F_B.jpg}
		      \caption{Kết quả sau bước 3: TotalPrice = 250,000}
	      \end{figure}

	      \begin{lstlisting}
-- Ap dung ma giam 10000
INSERT INTO APPLY_FOR (Promo_Code, Booking_ID) 
VALUES ('TEST_10PERCENT', 'BK_TEST');

-- Kiem tra gia (Ky vong: 250k - 10000 = 240,000)
SELECT Booking_ID, TotalPrice AS [Gia Buoc 4 (240k)] FROM BOOKING WHERE Booking_ID = 'BK_TEST';
\end{lstlisting}

	      \begin{figure}[h!]
		      \centering
		      \includegraphics[width=0.4\textwidth]{images/Gia tien Voucher.jpg}
		      \caption{Kết quả sau bước 4: TotalPrice = 240,000}
	      \end{figure}
\end{itemize}
% TODO

\subsection{Thủ tục truy vấn}
\subsubsection{Thủ tục \texttt{sp\_ReportUserSpendingByDate}}
\begin{lstlisting}
CREATE PROCEDURE sp_ReportUserSpendingByDate
    @StartDate DATETIME,
    @EndDate DATETIME,
    @MinSpending DECIMAL(18, 2)
AS
BEGIN
    SET NOCOUNT ON;

    IF @StartDate IS NULL OR @EndDate IS NULL
    BEGIN
        ;THROW 51005, N'Loi: Cac tham so (@StartDate, @EndDate) la bat buoc.', 1;
    END

    IF @StartDate > @EndDate OR @StartDate > GETDATE() OR @EndDate > GETDATE()
    BEGIN
        ;THROW 51002, N'Loi: Thoi gian tra cuu khong hop le.', 1;
    END

    IF @MinSpending < 0
    BEGIN
        ;THROW 51001, N'Loi: Muc chi tieu toi thieu (@MinSpending) khong hop le.', 1;
    END

    PRINT N'Bat dau tao bao cao chi tieu...';

    SELECT 
        U.UserID,
        U.FirstName + ' ' + U.LastName AS "Ho Ten",
        U.Phone,
        U.Email,
        COUNT(B.Booking_ID) AS "Tong So Don Hang",
        SUM(B.TotalPrice) AS "Tong Chi Tieu"
    FROM 
        [USER] U
    JOIN 
        BOOKING B ON U.UserID = B.UserID
    JOIN 
        PAYMENT P ON B.PaymentID = P.Payment_ID
    WHERE 
        (B.BookingTime BETWEEN @StartDate AND @EndDate)
        AND P.Status = 'Success'
    GROUP BY 
        U.UserID, U.FirstName, U.LastName, U.Phone, U.Email
    HAVING 
        SUM(B.TotalPrice) >= ISNULL(@MinSpending, 0)
    ORDER BY 
        "Tong Chi Tieu" DESC;

    DECLARE @RowFound INT = @@ROWCOUNT;

    IF @RowFound = 0
    BEGIN
        PRINT N'Thong bao: Khong tim thay du lieu.';
    END
    ELSE
    BEGIN
        PRINT N'Thanh cong: Da tim thay ' + CAST(@RowFound AS NVARCHAR(10)) + N' khach hang.';
    END
END;
\end{lstlisting}
\textbf{Giải thích thủ tục:}

\texttt{sp\_ReportUserSpendingByDate} là thủ tục dùng để lọc ra danh sách những khách hàng đã chi tiêu trong một khoảng thời gian nhất định, đồng thời đạt mức chi tiêu tối thiểu.

Thủ tục yêu cầu 3 thông tin:
\begin{itemize}
	\item[-] @StartDate, @EndDate: Khoảng thời gian cần thu thập.
	\item[-] @MinSpending: Mức chi tiêu tối thiểu.
\end{itemize}

Thủ tục tiến hành kết nối các bảng USER, BOOKING, PAYMENT với điều kiện các đơn hàng phải thuộc trong khoảng thời gian cần thu thập.
Từ đó kết quả trả về sẽ bao gồm UserID, Họ tên USER, Số điện thoại, Email và các thuộc tính dẫn xuất như Tổng số đơn hàng và Tổng chi tiêu.

Từ danh sách kết quả trả về, thủ tục tiến hành gộp nhóm theo thông tin cá nhân của khách hàng,
đồng thời tính toán các thông tin về Tổng số đơn hàng và Tổng chi tiêu của khách hàng.

Sau khi đã thực hiện gộp nhóm và tính toán các thông số dẫn xuất, thủ tục tiến hành lọc các khách hàng có tổng chi tiêu thỏa yêu cầu về mức chi tối thiếu.

Cuối cùng, thủ tục trả về danh sách các kết quả thỏa mãn các bộ lọc, thông qua thao tác sắp xếp mức chi tiêu giảm dần để dễ dàng nhận biết các khách hàng ``VIP'' của hệ thống.

Dữ liệu trả về có thể được sử dụng để áp dụng các chương trình tri ân khách hàng đặc biệt dựa trên mức chi tiêu mà khách hàng đã thực hiện,
đồng thời cũng là công cụ hữu hiệu đối với các cấp quản lý khi đưa ra các quyết định quan trọng của hệ thống,

\textbf{Xử lý ngoại lệ}
\begin{itemize}
	\item[-] Nếu người dùng không truyền tham số @StartDate, @EndDate, thủ tục trả về lỗi và không thực thi truy vấn.
	\item[-] Nếu các tham số @StartDate, @EndDate không hợp lệ (Vd: @StartDate > @EndDate), thủ tục trả về lỗi và không thực thi truy vấn.
	\item[-] Nếu tham số @MinSpending được truyền vào không hợp lệ (Vd: số ấm), thủ tục trả về lỗi và không thực thi truy vấn.
\end{itemize}

\textbf{Testing}
\begin{lstlisting}
-- Test 1: Truy suat thong tin hop le
EXEC sp_ReportUserSpendingByDate 
    @StartDate = '2024-01-01', 
    @EndDate = '2024-12-31', 
    @MinSpending = 200000;

-- Test 2: Truyen tham so khong hop le
EXEC sp_ReportUserSpendingByDate 
    @StartDate = NULL,
    @EndDate = NULL,
    @MinSpending = NULL;

-- Test 3: Tham so @MinSpending khong hop le
EXEC sp_ReportUserSpendingByDate 
    @StartDate = '2024-01-01', 
    @EndDate = '2024-12-31', 
    @MinSpending = -1;

-- Test 4: Tham so @MinSpending khong duoc truyen, gia tri mac dinh la 0
EXEC sp_ReportUserSpendingByDate 
    @StartDate = '2024-01-01', 
    @EndDate = '2024-12-31', 
    @MinSpending = NULL;
\end{lstlisting}
\textbf{Kết quả}
\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{Images/TT1_Test1_1.png}
	\includegraphics[width=\textwidth]{Images/TT1_Test1_2.png}
	\caption{Kết quả Test 1}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{Images/TT1_Test2.png}
	\caption{Kết quả Test 2}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{Images/TT1_Test3.png}
	\caption{Kết quả Test 3}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{Images/TT1_Test4_1.png}
	\includegraphics[width=\textwidth]{Images/TT1_Test4_2.png}
	\caption{Kết quả Test 4}
\end{figure}

\subsubsection{Thủ tục \texttt{sp\_SearchShowtime}}
\begin{lstlisting}
CREATE PROCEDURE sp_SearchShowtime
    @MovieTitle NVARCHAR(100),
    @SearchDate DATE
AS
BEGIN
    SET NOCOUNT ON;

    IF @MovieTitle IS NULL OR LTRIM(RTRIM(@MovieTitle)) = '' OR @SearchDate IS NULL
    BEGIN
        ;THROW 51005, N'Loi: Cac tham so (@MovieTitle, @SearchDate) la bat buoc.', 1;
    END

    IF @SearchDate > GETDATE()
    BEGIN
        ;THROW 51003, N'Loi: Ngay tim kiem (@SearchDate) khong hop le.', 1;
    END

    PRINT N'Tu khoa phim: ' + @MovieTitle;
    PRINT N'Thoi gian tu ngay: ' + CONVERT(NVARCHAR, @SearchDate, 103);
    PRINT N'Dang tim kiem lich chieu...';

    SELECT 
        M.Title AS "Ten Phim",
        C.Name AS "Ten Rap",
        R.RoomName AS "Phong Chieu",
        R.RoomType AS "Loai Phong",
        S.StartTime AS "Gio Chieu",
        S.BasePrice AS "Gia Ve Co Ban"
    FROM 
        SHOWTIME S
    JOIN 
        MOVIE M ON S.Movie_ID = M.Movie_ID
    JOIN 
        ROOM R ON S.Room_ID = R.Room_ID
    JOIN 
        CINEMA C ON R.CinemaID = C.CinemaID
    WHERE 
        M.Title LIKE '%' + @MovieTitle + '%'
        AND CAST(S.StartTime AS DATE) >= @SearchDate
    ORDER BY 
        M.Title ASC,
        S.StartTime ASC,
        C.Name ASC;
    
    DECLARE @RowFound INT = @@ROWCOUNT;

    IF @RowFound = 0
    BEGIN
        PRINT N'Thong bao: Khong tim thay suat chieu nao phu hop.';
    END
    ELSE
    BEGIN
        PRINT N'Thanh cong: Tim thay ' + CAST(@RowFound AS NVARCHAR(10)) + N' suat chieu.';
    END
END;
\end{lstlisting}
\textbf{Giải thích thủ tục:}

\texttt{sp\_SearchShowtime} là thủ tục được thiết kế để tìm kiếm lịch chiếu phim trong hệ thống.
Nó cho phép người dùng (hoặc ứng dụng) tìm các suất chiếu dựa trên tên phim (gần đúng) và ngày bắt đầu xem.

Thủ tục yêu cầu 2 thông tin:
\begin{itemize}
	\item[-] @MovieTitle: Tên phim cần tìm (hỗ trợ tiếng Việt có dấu)
	\item[-] @SearchDate: Mốc thời gian tìm kiếm
\end{itemize}

Thủ tục tiến hành kết nối các bảng MOVIE, ROOM, CINEMA vào SHOWTIME. Từ đó, kết quả trả về sẽ bao gồm Tên phim, Tên rạp, Phòng chiếu, Loại phòng, Giờ chiếu và Giá vé.

Từ danh sách đã kết nối, thủ tục tiến hành các bộ lọc:
\begin{itemize}
	\item[-] Lọc tên phim: Thủ tục áp dụng phép tính gần đúng để tìm tất cả các phim có chứa tên phim được yêu cầu.
	\item[-] Lọc thời gian tìm kiếm: Sau khi lọc theo tên phim, thủ tục tiếp tục lọc các suất chiếu từ ngày được yêu cầu trở về sau. Điều này giúp hệ thống gợi ý thêm cho người dùng nếu phim người dùng mong muốn không có suất chiếu trong ngày hôm đó.
\end{itemize}

Cuối cùng, thủ tục trả về danh sách các kết quả thỏa mãn các bộ lọc, thông qua thao tác sắp xếp với mức ưu tiên cao nhất cho tên phim, tiếp theo là thời gian suất chiếu và cuối cùng theo tên rạp.

\textbf{Xử lý ngoại lệ}
\begin{itemize}
	\item[-] Nếu người dùng không truyền tham số @MovieTitle, @SearchDate hoặc truyền dữ liệu rỗng, thủ tục trả về lỗi và không thực thi truy vấn.
	\item[-] Nếu tham số @SearchDate không hợp lệ (Vd: @SearchDate > GETDATE()), thủ tục trả về lỗi và không thực thi truy vấn.
\end{itemize}

\textbf{Testing}
\begin{lstlisting}
-- Test 1: Truy xuat thong tin hop le
EXEC sp_SearchShowtime @MovieTitle = N'Lat Mat', @SearchDate = '2024-01-01';

-- Test 2: Truyen tham so khong hop le
EXEC sp_SearchShowtime @MovieTitle = N'', @SearchDate = '';

-- Test 3: Thoi gian truy xuat khong hop le
EXEC sp_SearchShowtime @MovieTitle = N'Mai', @SearchDate = '2026-01-01';
\end{lstlisting}

\textbf{Kết quả}
\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{Images/TT2_Test1_1.png}
	\includegraphics[width=\textwidth]{Images/TT2_Test1_2.png}
	\caption{Kết quả Test 1}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{Images/TT2_Test2.png}
	\caption{Kết quả Test 2}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{Images/TT2_Test3.png}
	\caption{Kết quả Test 3}
\end{figure}

\subsubsection{Thủ tục \texttt{sp\_SearchUsersByBookingCount}}
\begin{lstlisting}
CREATE PROCEDURE sp_SearchUsersByBookingCount
    @Keyword NVARCHAR(100),
    @MaxBookingCount INT
AS
BEGIN
    SET NOCOUNT ON;
    IF @MaxBookingCount < 0
    BEGIN
        ;THROW 51001, N'Loi: So luong don hang toi da khong duoc am.', 1;
    END

    SELECT 
        U.UserID,
        ISNULL(U.FirstName, '') + ' ' + ISNULL(U.LastName, '') AS FullName,
        U.Email,
        U.Phone,
        COUNT(B.Booking_ID) AS TotalBookings,
        ISNULL(SUM(B.TotalPrice), 0) AS TotalSpent
    FROM 
        [USER] U
    LEFT JOIN 
        BOOKING B ON U.UserID = B.UserID
    LEFT JOIN 
        PAYMENT P ON B.PaymentID = P.Payment_ID 
    WHERE
        (@Keyword IS NULL OR U.Email LIKE '%' + @Keyword + '%' OR U.FirstName LIKE '%' + @Keyword + '%')
    GROUP BY
        U.UserID, U.FirstName, U.LastName, U.Email, U.Phone
    HAVING 
        COUNT(B.Booking_ID) <= ISNULL(@MaxBookingCount, 999999)
    ORDER BY 
        TotalBookings ASC, TotalSpent DESC;

    DECLARE @RowFound INT = @@ROWCOUNT;
    IF @RowFound = 0
        PRINT N'Khong tim thay khach hang nao.';
    ELSE
        PRINT N'Tim thay ' + CAST(@RowFound AS NVARCHAR(10)) + N' khach hang.';
END;
\end{lstlisting}
\textbf{Giải thích thủ tục:}

\texttt{sp\_SearchUsersByBookingCount} là thủ tục được thiết kế truy xuất danh sách người dùng ít hoạt động.
Nó giúp quản lý thu thập thông tin phục vụ các chiến dịch Marketing, kích cầu tiêu dùng và ưu đãi cho các khách hàng đã dần lãng quên hệ thống.

Thủ tục yêu cầu 2 thông tin:
\begin{itemize}
	\item[-] @Keyword: Từ khóa tìm kiếm theo tên (có thể để trống).
	\item[-] @MaxBookingCount: Số lượng đơn hàng tối đa của một user.
\end{itemize}

Thủ tục tiến hành kết nối các bảng USER và BOOKING, PAYMENT. Từ đó, kết quả trả về sẽ bao gồm Thông tin cá nhân, Tổng số đơn hàng và tổng chi tiêu của từng cá nhân.

Từ danh sách đã kết nối, thủ tục tiến hành các bộ lọc:
\begin{itemize}
	\item[-] Lọc tên USER: Thủ tục áp dụng phép tính gần đúng để tìm tất cả các USER có tên gần giống với tham số truyền vào.
	\item[-] Lọc theo tổng số đơn đã đặt: Thủ tục tiến hành gộp nhóm theo thông tin cá nhân và tính toán tổng số đơn hàng đã đặt, lọc bỏ theo số lượng đơn hàng tối đa từ tham số truyền vào.
\end{itemize}

Cuối cùng, thủ tục trả về danh sách các kết quả thỏa mãn các bộ lọc, thông qua thao tác sắp xếp tổng số đơn hàng tăng dần và tổng chi tiêu giảm dần.

\textbf{Xử lý ngoại lệ}
\begin{itemize}
	\item[-] Nếu người dùng không truyền tham số @Keyword, thủ tục sẽ bỏ qua không lọc và vẫn tiếp tục truy vấn.
	\item[-] Nếu tham số @MaxBookingCount âm, thủ tục sẽ báo lỗi và ngừng truy vấn ngay lập tức.
	\item[-] Nếu tham số @MaxBookingCount không được truyền vào, thủ tục sẽ sử dụng giá trị mặc định là 99999 và tiếp tục truy vấn.
\end{itemize}

\textbf{Testing}
\begin{lstlisting}
-- Test 1: Truy suat thong tin hop le
EXEC sp_SearchUsersByBookingCount 
    @Keyword="Le",
    @MaxBookingCount=10;
-- Test 2: Khong truyen tham so
EXEC sp_SearchUsersByBookingCount 
    @Keyword=NULL,
    @MaxBookingCount=NULL
-- Test 3: Tham so @MaxBookingCount khong hop le
EXEC sp_SearchUsersByBookingCount 
    @Keyword="V",
    @MaxBookingCount=-2
\end{lstlisting}

\textbf{Kết quả}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.75\textwidth]{Images/TT3_Test1_1.png}
	\includegraphics[width=0.75\textwidth]{Images/TT3_Test1_2.png}
	\caption{Kết quả Test 1}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.75\textwidth]{Images/TT3_Test2_1.png}
	\includegraphics[width=0.75\textwidth]{Images/TT3_Test2_2.png}
	\caption{Kết quả Test 2}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.75\textwidth]{Images/TT3_Test3.png}
	\caption{Kết quả Test 3}
\end{figure}

\subsection{Hàm}
\subsubsection{Hàm \texttt{fn\_GetMovieRevenue}}
\begin{lstlisting}[language=SQL]
CREATE OR ALTER FUNCTION fn_GetMovieRevenue
(
    @MovieID VARCHAR(10)
)
RETURNS NVARCHAR(MAX)
AS
BEGIN
    DECLARE @Result NVARCHAR(MAX) = N'';
    DECLARE @MovieTitle NVARCHAR(100);
    DECLARE @TotalRevenue DECIMAL(18, 2) = 0;
    DECLARE @ShowtimeCount INT = 0;

    IF @MovieID IS NULL
        RETURN N'Lop: MovieID khong duoc NULL';

    SELECT @MovieTitle = Title FROM MOVIE WHERE Movie_ID = @MovieID;
    IF @MovieTitle IS NULL
        RETURN N'Loi: Khong tim thay phim voi ID: ' + @MovieID;

    SET @Result = N'Phim: ' + @MovieTitle + CHAR(13) + CHAR(10);

    DECLARE @ShowtimeID VARCHAR(10);
    DECLARE @StartTime DATETIME;
    DECLARE @Revenue DECIMAL(18, 2);

    DECLARE showtime_cursor CURSOR FOR
    SELECT S.Showtime_ID, S.StartTime
    FROM SHOWTIME S
    WHERE S.Movie_ID = @MovieID
    ORDER BY S.StartTime;

    OPEN showtime_cursor;
    FETCH NEXT FROM showtime_cursor INTO @ShowtimeID, @StartTime;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        SELECT @Revenue = ISNULL(SUM(B.TotalPrice), 0)
        FROM BOOKING B
        JOIN INCLUDE_SEAT I ON B.Booking_ID = I.Booking_ID
        WHERE I.Showtime_ID = @ShowtimeID;

        SET @TotalRevenue = @TotalRevenue + @Revenue;
        SET @ShowtimeCount = @ShowtimeCount + 1;

        SET @Result = @Result + 
            N'  Suat ' + CAST(@ShowtimeCount AS NVARCHAR) + 
            N' (' + CONVERT(NVARCHAR, @StartTime, 103) + N'): ' + 
            FORMAT(@Revenue, 'N0') + N' VND' + CHAR(13) + CHAR(10);

        FETCH NEXT FROM showtime_cursor INTO @ShowtimeID, @StartTime;
    END

    CLOSE showtime_cursor;
    DEALLOCATE showtime_cursor;

    SET @Result = @Result + 
        N'---' + CHAR(13) + CHAR(10) +
        N'Tong doanh thu: ' + FORMAT(@TotalRevenue, 'N0') + N' VND' + CHAR(13) + CHAR(10) +
        N'Tong so suat chieu: ' + CAST(@ShowtimeCount AS NVARCHAR);

    RETURN @Result;
END;
\end{lstlisting}
\textbf{Giải thích hàm:}

Hàm \texttt{fn\_GetMovieRevenue} được thiết kế để tính toán doanh thu chi tiết của một bộ phim dựa trên tất cả các suất chiếu của phim đó. Không chỉ trả về tổng doanh thu, hàm còn cung cấp báo cáo chi tiết từng suất chiếu dưới dạng chuỗi văn bản có cấu trúc.

Hàm yêu cầu 1 tham số duy nhất:
@MovieID là mã định danh duy nhất của bộ phim cần phân tích

Hàm truy vấn thông tin cơ bản của phim từ bảng MOVIE.
Sau đó khởi tạo con trỏ, truy vấn danh sách tất cả suất chiếu của phim (sắp xếp theo thời gian)
và sử dụng vòng lặp WHILE để duyệt qua từng suất chiếu, thực hiện:

\begin{itemize}
	\item[-] Tính doanh thu suất chiếu: Truy vấn tổng giá trị các vé đã bán cho suất chiếu hiện tại.
	\item[-] Cộng dồn tổng doanh thu: Tích lũy vào biến tổng doanh thu của phim.
	\item[-] Định dạng thông tin: Chuyển đổi dữ liệu thành chuỗi mô tả có cấu trúc.
	\item[-] Xây dựng báo cáo chi tiết: Thêm thông tin suất chiếu vào chuỗi kết quả.
\end{itemize}
\textbf{Xử lý ngoại lệ:}
\begin{itemize}
	\item[-] Nếu người dùng không truyền tham số @MovieID hoặc không thể tìm thấy phim với @MovieID tương ứng, hàm sẽ trả về thông báo lỗi cụ thể.
\end{itemize}

\textbf{Testing}

\begin{lstlisting}
-- Test 1: MovieID hop le
SELECT dbo.fn_GetMovieRevenue('MV001') AS MovieRevenueDetail;

-- Test 2: MovieID khong ton tai
SELECT dbo.fn_GetMovieRevenue('MV999') AS MovieRevenueDetail;

-- Test 3: MovieID NULL
SELECT dbo.fn_GetMovieRevenue(NULL) AS MovieRevenueDetail;
\end{lstlisting}

\textbf{Kết quả}
\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{Images/H1_Test1_1.png}
	\caption{Kết quả Test 1}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{Images/H1_Test1_2.png}
	\caption{Kết quả Test 2}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{Images/H1_Test1_3.png}
	\caption{Kết quả Test 3}
\end{figure}

\subsubsection{Hàm \texttt{fn\_GetRoomOccupancyRate}}
\begin{lstlisting}
    CREATE OR ALTER FUNCTION fn_GetRoomOccupancyRate
(
    @RoomID VARCHAR(10),
    @StartDate DATETIME,
    @EndDate DATETIME
)
RETURNS DECIMAL(5, 2)
AS
BEGIN
    DECLARE @OccupancyRate DECIMAL(5, 2) = 0;
    DECLARE @TotalSeats INT;
    DECLARE @TotalShowtimes INT = 0;
    DECLARE @TotalBookedSeats INT = 0;
    
    DECLARE @ShowtimeID VARCHAR(10);
    DECLARE @BookedSeats INT;
    
    IF @RoomID IS NULL OR LTRIM(RTRIM(@RoomID)) = ''
    BEGIN
        RETURN -1; 
    END
    
    IF @StartDate IS NULL OR @EndDate IS NULL
    BEGIN
        RETURN -2; 
    END
    
    IF @StartDate > @EndDate
    BEGIN
        RETURN -3; 
    END
    
    IF NOT EXISTS (SELECT 1 FROM ROOM WHERE Room_ID = @RoomID)
    BEGIN
        RETURN -4; 
    END
    
    SELECT @TotalSeats = Capacity 
    FROM ROOM 
    WHERE Room_ID = @RoomID;
    
    IF @TotalSeats = 0
    BEGIN
        RETURN 0; 
    END
    
    DECLARE showtime_cursor CURSOR FOR
    SELECT Showtime_ID
    FROM SHOWTIME
    WHERE Room_ID = @RoomID
        AND StartTime BETWEEN @StartDate AND @EndDate
    ORDER BY StartTime;
    
    OPEN showtime_cursor;
    FETCH NEXT FROM showtime_cursor INTO @ShowtimeID;
    
    WHILE @@FETCH_STATUS = 0
    BEGIN
        SET @TotalShowtimes = @TotalShowtimes + 1;
        
        SELECT @BookedSeats = COUNT(*)
        FROM INCLUDE_SEAT
        WHERE Showtime_ID = @ShowtimeID
            AND SeatStatus IN ('Booked', 'Sold');
        
        SET @TotalBookedSeats = @TotalBookedSeats + @BookedSeats;
        
        FETCH NEXT FROM showtime_cursor INTO @ShowtimeID;
    END
    
    CLOSE showtime_cursor;
    DEALLOCATE showtime_cursor;
    
    IF @TotalShowtimes > 0
    BEGIN
        SET @OccupancyRate = (CAST(@TotalBookedSeats AS DECIMAL(18, 2)) / 
                              (CAST(@TotalSeats AS DECIMAL(18, 2)) * @TotalShowtimes)) * 100;
    END
    ELSE
    BEGIN
        SET @OccupancyRate = 0;
    END
    
    RETURN @OccupancyRate;
END;
\end{lstlisting}
\textbf{Giải thích hàm:}

\texttt{fn\_GetRoomOccupancyRate} là hàm được thiết kế để tính toán tỷ lệ lấp đầy ghế của một phòng chiếu phim trong một khoảng thời gian cụ thể. Tỷ lệ này là chỉ số quan trọng đánh giá hiệu quả sử dụng không gian và khả năng thu hút khán giả của phòng chiếu.

Hàm yêu cầu 3 tham số:

\begin{itemize}
	\item[-] @RoomID: Mã định danh của phòng chiếu cần phân tích.
	\item[-] @StartDate: Ngày bắt đầu khoảng thời gian phân tích.
	\item[-] @EndDate: Ngày kết thúc khoảng thời gian phân tích.
\end{itemize}

Hàm truy vấn tổng số ghế (Capacity) từ bảng ROOM và trả về 0 ngay lập tức nếu phòng không có ghế (Capacity = 0).

Hàm sử dụng con trỏ và vòng lặp WHILE để duyệt tuần tự qua tất cả các suất chiếu của phòng:

\begin{itemize}
	\item[-] Tăng bộ đếm suất chiếu: Theo dõi tổng số suất chiếu trong khoảng thời gian.
	\item[-] Đếm ghế đã đặt: Truy vấn số ghế có trạng thái 'Booked' hoặc 'Sold' cho mỗi suất chiếu.
	\item[-] Cộng dồn số ghế: Tích lũy tổng số ghế đã đặt qua tất cả suất chiếu.
\end{itemize}

Sau khi thu thập đầy đủ dữ liệu hàm tính toán tỉ lệ lấp đầy theo công thức:

Occupancy Rate = (Tổng số ghế đã đặt / (Sức chứa phòng × Tổng số suất chiếu)) × 100%

\textbf{Xử lý ngoại lệ:}
\begin{itemize}
	\item[-] Nếu người dùng không truyền tham số @RoomID, @StartDate hoặc @EndDate, hàm sẽ trả về mã lỗi tương ứng (-1 cho RoomID và -2 cho StartDate và EndDate).
	\item[-] Nếu EndDate bé hơn StartDate thì hàm sẽ trả về mã lỗi là -3.
	\item[-] Nếu RoomID không tồn tại thì hàm sẽ trả về mã lỗi là -4.
\end{itemize}

\textbf{Testing}

\begin{lstlisting}
-- Test 1: Tinh ti le lap day cho phong hop le
DECLARE @Rate DECIMAL(5, 2);
SET @Rate = dbo.fn_GetRoomOccupancyRate('R001', '2024-01-01', '2024-12-31');
SELECT @Rate AS [Occupancy Rate (%)];

-- Test 2: RoomID khong ton tai
SELECT dbo.fn_GetRoomOccupancyRate('R999', '2024-01-01', '2024-12-31') AS [Result];

-- Test 3: Ngay khong hop le
SELECT dbo.fn_GetRoomOccupancyRate('R001', '2024-12-31', '2024-01-01') AS [Result];
\end{lstlisting}

\textbf{Kết quả}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.45\textwidth]{Images/H2_Test1_1.png}
	\caption{Kết quả Test 1}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.4\textwidth]{Images/H2_Test1_2.png}
	\caption{Kết quả Test 2}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.4\textwidth]{Images/H2_Test1_3.png}
	\caption{Kết quả Test 3}
\end{figure}
\section{Hiện thực ứng dụng }
\cach Nhóm đã phát triển một ứng dụng web quản lý rạp chiếu phim để minh họa việc kết nối và tương tác với cơ sở dữ liệu SQL Server. Ứng dụng tập trung vào các thao tác dữ liệu thông qua Stored Procedures và xử lý các ràng buộc nghiệp vụ.

\subsection{Kiến trúc hệ thống}

\cach Hệ thống tuân theo mô hình Client-Server 3 lớp:

\begin{itemize}
	\item \textbf{Database Layer (SQL Server):} Lưu trữ dữ liệu, đảm bảo toàn vẹn dữ liệu thông qua Constraints, Triggers và cung cấp logic nghiệp vụ qua Stored Procedures.
	\item \textbf{Backend Layer (Node.js + Express):} Cung cấp RESTful API. Sử dụng thư viện \texttt{mssql} để kết nối Database, thực thi các thủ tục lưu trữ và xử lý logic trung gian (Authentication, Validation).
	\item \textbf{Frontend Layer (Next.js):} Giao diện người dùng (UI) được xây dựng bằng React, tương tác với Backend qua HTTP Requests (Axios/Fetch).
\end{itemize}



\begin{figure}[H]
	\centering
	\framebox{\parbox{0.8\textwidth}{\centering
			\vspace{1.5cm}
			\textbf{[Client (Next.js) $\leftrightarrow$ API (Express) $\leftrightarrow$ Database (SQL Server)]}
			\vspace{1.5cm}
		}}
	\caption{Mô hình kiến trúc ứng dụng}
	\label{fig:architecture}
\end{figure}

\subsection{Kết nối Cơ sở dữ liệu}

Kết nối được thiết lập trong file \texttt{db.js} sử dụng biến môi trường để bảo mật.

\begin{lstlisting}[language=JavaScript]
import sql from "mssql";

const sqlConfig = {
    user: process.env.DB_USER,      
    password: process.env.DB_PASSWORD, 
    database: "BTL_DB",             
    server: process.env.DB_SERVER,  
    port: +process.env.DB_PORT,
    options: {
        encrypt: true,
        trustServerCertificate: false
    }
};

const connectDB = async () => {
    try {
        await sql.connect(sqlConfig);
        console.log("Microsoft SQL server connected");
    } catch (error) {
        console.error("Connection failed:", error);
    }
};
export default { connectDB };
\end{lstlisting}
\subsection{Hiện thực Backend và Frontend}

\subsubsection{Quản lý Người dùng (User Management)}

\cach Đây là chức năng chính minh họa cho việc Thêm/Xóa/Sửa dữ liệu (Câu 3.1) và Hiển thị danh sách/Xử lý lỗi (Câu 3.2).

\textbf{1. Backend API (Controller)}

File \texttt{userController.js} xử lý các request từ client và gọi các Stored Procedure tương ứng: \texttt{sp\_InsertUser}, \texttt{sp\_UpdateUser}, \texttt{sp\_DeleteUser}.

\begin{lstlisting}[language=JavaScript]
// 1. Them nguoi dung (Goi sp_InsertUser)
export const createUser = async (req, res) => {
    const { UserID, FirstName, LastName, Email, Phone, Password, ... } = req.body;
    try {
        const request = new sql.Request();
        request.input("UserID", sql.VarChar(10), UserID);
        // ... mapping cac tham so khac
        
        // Thuc thi thu tuc
        await request.execute("sp_InsertUser");
        res.status(201).json({ message: "Them nguoi dung thanh cong!" });
    } catch (error) {
        // Bat loi vi pham rang buoc (VD: UserID da ton tai)
        res.status(400).json({ message: error.message });
    }
};
// 2. Cap nhat nguoi dung (Goi sp_UpdateUser)
export const updateUser = async (req, res) => {
    const { id } = req.params; 
    const { NewEmail, NewPhone, NewPassword } = req.body;

    try {
        const request = new sql.Request();
        request.input("UserID", sql.VarChar(10), id);
        request.input("NewEmail", sql.VarChar(100), NewEmail);
        request.input("NewPhone", sql.VarChar(15), NewPhone);
        request.input("NewPassword", sql.VarChar(50), NewPassword);

        await request.execute("sp_UpdateUser");

        res.status(200).json({ message: "Cap nhat thanh cong!" });
    } catch (error) {
        console.error("SQL Error:", error.message);
        res.status(400).json({ message: error.message });
    }
};
// 3. Xoa nguoi dung (Goi sp_DeleteUser)
export const deleteUser = async (req, res) => {
    const { id } = req.params;
    try {
        const request = new sql.Request();
        request.input("UserID", sql.VarChar(10), id);
        
        await request.execute("sp_DeleteUser");
        res.status(200).json({ message: "Xoa thanh cong!" });
    } catch (error) {
        // Bat loi khoa ngoai (VD: User da mua ve)
        res.status(400).json({ message: error.message });
    }
};
\end{lstlisting}

\textbf{2. Frontend (Giao diện và Logic)}

Giao diện \texttt{/users} được thiết kế để đáp ứng các yêu cầu:
\begin{itemize}
	\item \textbf{Danh sách dữ liệu:} Hiển thị bảng User với đầy đủ thông tin.
	\item \textbf{Thêm/Sửa trên cùng giao diện:} Form tự động chuyển đổi trạng thái. Khi sửa, các trường không được phép thay đổi (như UserID, Tên) sẽ bị khóa hoặc ẩn đi, tuân thủ logic của \texttt{sp\_UpdateUser}.
	\item \textbf{Xử lý lỗi logic:} Các lỗi từ Database (như nhập mật khẩu < 8 ký tự, xóa user đang có vé) được hiển thị rõ ràng cho người dùng thông qua thông báo (Toast/Alert).
\end{itemize}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\textwidth]{Images/fe1.jpg}
	\includegraphics[width=0.9\textwidth]{Images/fe3.jpg}
	\includegraphics[width=0.9\textwidth]{Images/fe2.jpg}
	\caption{Giao diện Quản lý Người dùng}
\end{figure}

\subsubsection{Thống kê và Quản lý Khách hàng (User Statistics \& Management)}

\cach Chức năng này minh họa cho yêu cầu Tìm kiếm snâng cao và Thống kê tổng hợp.
Hệ thống cho phép lọc người dùng dựa trên tên và ố lượng đơn hàng đã đặt, đồng thời tính toán tổng chi tiêu (sử dụng kết hợp \texttt{COUNT}, \texttt{SUM} và \texttt{HAVING}).

\textbf{1. Backend API (Controller)}

File \texttt{procedureController.js} xử lý logic tìm kiếm thông qua phương thức \texttt{countBooking}.
API nhận tham số từ Query String, xử lý thành tham số đầu vào của thủ tục và tiến hành thực thi thủ tục:
\begin{itemize}
	\item \textbf{Xử lý tham số:} Biến \texttt{q} tương đương tham số \texttt{@Keyword}, biến \texttt{max} tương đương tham số \texttt{@MaxBookingCount}.
	\item \textbf{Chuẩn hóa dữ liệu:} Xử lý các trường hợp mặc định (tham số \texttt{null}) và ép kiểu số nguyên trước khi truyền vào \texttt{sql.Request}.
	\item \textbf{Trả về kết quả:} Kết quả thực thi (\texttt{data.recordset}) được trả về trực tiếp dưới dạng JSON để Frontend hiển thị.
\end{itemize}

\begin{lstlisting}[language=JavaScript]
const ProcedureController = {
    countBooking: async (req, res) => {
        try {
            const { q: keyword = null, max: limit = null } = req.query;
            const request = new sql.Request();
            request.input("Keyword", sql.NVarChar, keyword);
            request.input("MaxBookingCount", sql.Int, limit ? +limit : null);
            const data = await request.execute("sp_SearchUsersByBookingCount");
            res.status(200).json({ message: "Query success", data: data.recordset });
        } catch (error) {
            console.log(error);
            res.status(500).json({ message: "Server error", error: error.message });
        }
    },
};
\end{lstlisting}

\textbf{2. Frontend (Giao diện và Logic)}

Giao diện \texttt{/admin/customer-filter} được thiết kế tập trung trên một màn hình duy nhất với 3 khu vực chức năng chính để tối ưu thao tác người dùng:

\begin{itemize}
	\item \textbf{Form thêm người dùng nhanh:} Cung cấp các trường nhập liệu chi tiết (UserID, Tên, Email, Mật khẩu...). Hệ thống tự động kiểm tra dữ liệu đầu vào và hiển thị thông báo trạng thái (thành công hoặc lỗi từ server) ngay phía dưới form để người dùng dễ dàng nhận biết.
	\item \textbf{Bộ lọc Thống kê:} Đây là công cụ chính của người quản trị hệ thống, cho phép tìm kiếm nâng cao dựa trên từ khóa và giới hạn số lượng đơn hàng (Max Booking). Dữ liệu trả về không chỉ có thông tin cá nhân mà còn bao gồm các chỉ số thống kê tổng hợp (Tổng số đơn, Tổng chi tiêu).
	\item \textbf{Bảng dữ liệu tương tác:} Đây là giao diện chính mà người quản trị hệ thống tương tác để đưa ra các chiến lược đối quan trọng thông qua nguồn thông tin dữ liệu trả về (kết quả trả về là quá trình thực thi thủ tục \texttt{sp\_SearchUsersByBookingCount} với các tham số là dữ liệu từ bộ lọc bên trên)
	      \begin{itemize}
		      \item \textit{Sắp xếp (Sorting):} Người dùng có thể nhấp vào tiêu đề cột để sắp xếp dữ liệu tăng/giảm dần ngay lập tức mà không cần tải lại trang.
		      \item \textit{Xử lý xóa an toàn:} Thao tác xóa được đảm bảo bằng hộp thoại xác nhận (Modal Popup). Nếu xảy ra lỗi, thông báo lỗi cụ thể sẽ hiển thị ngay trong hộp thoại để cảnh báo người dùng.
	      \end{itemize}
\end{itemize}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\textwidth]{Images/fe4.jpg}
	\includegraphics[width=0.9\textwidth]{Images/fe5.jpg}
	\caption{Giao diện Thống kê và Quản lý Khách hàng}
\end{figure}

\end{document}